<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>KPIs, Milestones, and associated Activities</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --primary:#0066cc;
      --primary-dark:#004c99;
      --ink:#2b2b2b;
      --bg:#f7f9fb;
      --card:#ffffff;
      --muted:#6b7280;
      --line:#d9e1ea;
      --pill:#f0f4f8;
      --done:#28a745; --work:#ffc107; --stuck:#dc3545; --pend:#6c757d;
    }
    *{box-sizing:border-box}
    body{font-family:'Segoe UI',Tahoma,sans-serif;background:var(--bg);color:var(--ink);margin:0;padding:28px 16px 40px}
    h1{font-size:28px;font-weight:700;margin:0 0 16px;color:#103c60;border-bottom:2px solid var(--line);padding-bottom:10px}

    /* Search bar */
    .search-row{display:flex;gap:8px;align-items:center;margin:8px 0 10px}
    .search-input{flex:1;height:44px;border:2px solid var(--primary);border-radius:6px;padding:0 12px;font-size:15px}
    .btn{height:44px;padding:0 14px;border:none;border-radius:6px;background:var(--primary);color:#fff;font-weight:600;cursor:pointer}
    .btn:hover{background:var(--primary-dark)}
    .btn-secondary{background:#e5e7eb;color:#111827}
    .btn-secondary:hover{background:#d1d5db}
    .tip{font-size:12px;color:#6b7280;margin:2px 0 12px}
    .btn-compact{height:36px}

    /* Strategy matches panel */
    .pdf-box{background:#eef6ff;border:1px solid #cde1ff;border-radius:8px;padding:12px 14px;margin:10px 0 18px}
    .pdf-title{font-weight:700;color:#123a63;margin-bottom:6px}
    .pdf-hits{list-style:none;margin:8px 0 0;padding:0}
    .pdf-hit{font-size:14px;color:#1f2937;margin:6px 0}
    .pdf-open{margin-top:8px;font-size:13px}
    mark{background:#fff3a3;border-radius:2px;padding:0 2px}

    /* Top/bottom controls */
    .controls{display:flex;gap:8px;justify-content:flex-end;margin:6px 0 14px}
    .refresh-btn{padding:10px 16px;background:var(--primary);color:#fff;border:none;border-radius:6px;font-size:14px;cursor:pointer}
    .refresh-btn:hover{background:var(--primary-dark)}

    /* Section headers (KPI pillars) */
    .section-heading-container{display:flex;align-items:center;gap:8px;cursor:pointer;margin-top:22px;padding-left:10px;border-left:5px solid #003e6b}
    h2.section-heading{font-size:18px;margin:0;color:#003e6b}
    .section-arrow{font-size:14px;transition:transform .3s ease;color:#003e6b}
    .collapsed .section-arrow{transform:rotate(-90deg)}
    .section-description{font-size:13px;color:#444;margin:8px 0 10px 6px;font-style:italic}

    /* KPI progress bars */
    .kpi-progress-container{margin:8px 0 14px 6px}
    .progress-bar{display:flex;height:10px;border-radius:6px;overflow:hidden;background:#e5e7eb;width:100%}
    .bar-segment{height:100%}
    .bar-done{background:var(--done)} .bar-working{background:var(--work)}
    .bar-stuck{background:var(--stuck)} .bar-pending{background:var(--pend)}

    /* Milestone cards */
    ul{margin:0;padding:0}
    li.milestone-container{display:flex;position:relative;background:var(--card);border:1px solid #e0e4e8;border-radius:10px;padding:14px 16px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,.05)}
    .milestone-badge{flex-shrink:0;width:44px;display:flex;align-items:center;justify-content:center;font-weight:700;color:#003e6b;background:var(--pill);border-right:2px solid #d1d9e0;border-radius:8px 0 0 8px;writing-mode:vertical-rl;text-orientation:mixed;transform:rotate(180deg);font-size:13px;letter-spacing:.5px}
    .milestone-badge.done{background:var(--done);color:#fff}
    .milestone-content{flex:1;padding-left:12px;display:flex;flex-direction:column}
    .milestone-header{display:flex;gap:10px;align-items:flex-start;justify-content:space-between;margin-bottom:6px}
    .description{font-style:italic;font-size:13px;color:#555;flex:1}
    .metadata-line{font-size:12px;margin-top:4px;padding:6px 0;color:#333;display:flex;flex-wrap:wrap;gap:16px}
    .metadata-line strong{font-weight:600;margin-right:4px}

    .activity-summary{display:flex;align-items:center;justify-content:space-between;margin:6px 0 8px}
    .activity-toggle{display:inline-flex;align-items:center;gap:6px;font-size:13px;color:var(--primary);cursor:pointer}
    .activity-toggle:hover{text-decoration:underline}
    .arrow{display:inline-block;transition:transform .3s ease}
    .collapsed .arrow{transform:rotate(-90deg)}
    .status-circles{display:flex;gap:4px}
    .circle{width:10px;height:10px;border-radius:50%}
    .circle.done{background:var(--done)}
    .circle.working{background:var(--work)}
    .circle.stuck{background:var(--stuck)}
    .circle.pending{background:var(--pend)}

    .sublist{margin-top:8px;list-style:none;padding-left:0}
    .subitem{padding:12px;border:1px solid #d5dce1;border-radius:10px;margin-bottom:8px;font-size:13px;background:#f8fafc;display:flex;align-items:center;gap:10px}
    .status-indicator{width:14px;height:14px;border-radius:50%}
    .status-done{background:var(--done)}
    .status-working{background:var(--work)}
    .status-pending{background:var(--pend)}
    .status-stuck{background:var(--stuck)}
    .status-default{background:#d5dce1}
    .subitem-content{flex:1}
    .pill{display:inline-block;font-size:12px;margin-top:4px;margin-right:12px}
    .overdue{color:#fff;background:var(--stuck);border-radius:4px;padding:1px 4px}
    .missing-data{color:#fff;background:var(--work);border-radius:4px;padding:1px 4px}

    .email-taskforce-btn{padding:6px 10px;font-size:12px;background:var(--primary);color:#fff;border:none;border-radius:4px;cursor:pointer;white-space:nowrap}
    .email-taskforce-btn:hover{background:var(--primary-dark)}

    .hidden{display:none}

    /* Overlay */
    #loadingOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:2000;display:flex;align-items:center;justify-content:center;color:#fff;font-size:18px;font-weight:700;text-align:center;padding:20px}
    .pulse-word{animation:pulse 1.5s infinite;color:var(--done)}
    @keyframes pulse{0%{transform:scale(1);opacity:1}50%{transform:scale(1.2);opacity:.7}100%{transform:scale(1);opacity:1}}

    /* Responsive */
    @media (max-width:700px){
      .milestone-badge{width:40px}
      .metadata-line{gap:10px}
    }
  </style>
</head>
<body>
  <h1>KPIs, Milestones, and associated Activities</h1>

  <!-- Search -->
  <div class="search-row">
    <input id="searchInput" class="search-input" type="text" placeholder="Search pillars, KPIs, milestones, activities…" />
    <button id="searchBtn" class="btn">Search</button>
    <button id="clearBtn" class="btn btn-secondary">Clear</button>
  </div>
  <div class="tip">Tip: try terms like <em>CRISPR</em>, <em>genomics</em>, <em>clinical trial</em>, etc.</div>

  <!-- Strategy matches -->
  <div id="strategyMatches" class="pdf-box"></div>

  <!-- Top controls -->
  <div class="controls">
    <button class="refresh-btn btn-compact" onclick="expandAll()">Expand All</button>
    <button class="refresh-btn btn-compact" onclick="collapseAll()">Collapse All</button>
    <button class="refresh-btn btn-compact" onclick="loadData()">Refresh Data</button>
  </div>

  <!-- CORE DATA ONLY -->
  <div id="milestoneSections"></div>

  <!-- Bottom controls -->
  <div class="controls">
    <button class="refresh-btn btn-compact" onclick="expandAll()">Expand All</button>
    <button class="refresh-btn btn-compact" onclick="collapseAll()">Collapse All</button>
    <button class="refresh-btn btn-compact" onclick="loadData()">Refresh Data</button>
  </div>

  <div id="loadingOverlay">Gathering <span class="pulse-word">IMPACT</span> data from ONJCRI…</div>

  <script>
    /* ===== Config ===== */
    // Public Strategy PDF you provided (change if needed)
    const STRATEGY_PDF_URL = "https://www.onjcri.org.au/wp-content/uploads/2025/06/ONJCRI_Impact-Strategy_16-page_WEB.pdf";

    /* ===== State ===== */
    let originalData = null;
    let lastQuery = "";

    /* ===== Utilities ===== */
    const overlay = document.getElementById('loadingOverlay');
    function formatAU(dateStr){return dateStr}
    function isOverdue(endDateStr){
      if(!endDateStr) return false;
      const parts=endDateStr.split('/');
      if(parts.length!==3) return false;
      const [d,m,y]=parts.map(Number);
      return new Date(y,m-1,d)<new Date();
    }
    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));
    }
    function normalize(s){ return String(s||"").toLowerCase(); }

    /* ===== Load data ===== */
    async function loadData(){
      overlay.style.display='flex';
      try{
        const res = await fetch('/api/milestones');
        const data = await res.json();
        if(!data.success) throw new Error(data.error||'Unknown error');
        originalData=data;
        applySearch(lastQuery); // render (filtered or full)
      }catch(err){
        console.error(err);
      }finally{
        overlay.style.display='none';
      }
    }

    /* ===== Search filter ===== */
    function filterDataByQuery(data, q){
      if(!q) return JSON.parse(JSON.stringify(data));
      const needle = q.toLowerCase();

      const filtered = JSON.parse(JSON.stringify(data));
      filtered.items = filtered.items.map(item=>{
        const itemText = [item.name,item.description,item.portfolio,item.date].join(' ').toLowerCase();
        const keepItem = itemText.includes(needle) ||
          item.subitems.some(sub=> [sub.name,sub.status,sub.sponsor,sub.lead,sub.timeline].join(' ').toLowerCase().includes(needle) );

        if(!keepItem){
          // If item itself doesn't match, we still may keep only matching subitems
          const newSubs = item.subitems.filter(sub=> [sub.name,sub.status,sub.sponsor,sub.lead,sub.timeline].join(' ').toLowerCase().includes(needle));
          if(newSubs.length===0) return null;
          return {...item, subitems:newSubs};
        }
        return item;
      }).filter(Boolean);

      return filtered;
    }

    function applySearch(q){
      lastQuery=q||"";
      const filtered = filterDataByQuery(originalData, lastQuery);
      renderSections(filtered);
      searchStrategyMatches(lastQuery);
    }

    /* ===== Strategy PDF matches (only the term clickable) ===== */
    async function searchStrategyMatches(query){
      const box = document.getElementById('strategyMatches');
      if(!query){
        box.innerHTML = "";
        return;
      }
      if(!STRATEGY_PDF_URL){
        box.innerHTML = `<div class="pdf-title">Impact Strategy matches</div>
          <div class="pdf-open"><a href="#" onclick="return false">No Strategy PDF configured</a></div>`;
        return;
      }

      box.innerHTML = `<div class="pdf-title">Impact Strategy matches</div><div class="pdf-open">Searching Strategy PDF…</div>`;

      try{
        const resp = await fetch(`/api/pdf-search?url=${encodeURIComponent(STRATEGY_PDF_URL)}&q=${encodeURIComponent(query)}`);
        const json = await resp.json();

        if(!json.success){
          box.innerHTML = `<div class="pdf-title">Impact Strategy matches</div>
            <div class="pdf-open">Cannot search the PDF right now. <a href="${STRATEGY_PDF_URL}" target="_blank" rel="noopener">Open PDF</a></div>`;
          return;
        }
        if(!json.matches || json.matches.length===0){
          box.innerHTML = `<div class="pdf-title">Impact Strategy matches</div>
            <div class="pdf-open">No mentions found. <a href="${STRATEGY_PDF_URL}" target="_blank" rel="noopener">Open PDF</a></div>`;
          return;
        }

        const list = json.matches.map(m=>{
          const escaped = escapeHtml(m.snippet);
          const rx = new RegExp(`(${escapeRegex(query)})`,'gi');
          const line = escaped.replace(rx, `<a href="${STRATEGY_PDF_URL}" target="_blank" rel="noopener"><mark>$1</mark></a>`);
          return `<li class="pdf-hit">… ${line} …</li>`;
        }).join('');

        box.innerHTML = `<div class="pdf-title">Impact Strategy matches</div>
          <ul class="pdf-hits">${list}</ul>
          <div class="pdf-open"><a href="${STRATEGY_PDF_URL}" target="_blank" rel="noopener">Open full Strategy PDF</a></div>`;
      }catch(e){
        box.innerHTML = `<div class="pdf-title">Impact Strategy matches</div>
          <div class="pdf-open">Cannot search the PDF right now. <a href="${STRATEGY_PDF_URL}" target="_blank" rel="noopener">Open PDF</a></div>`;
      }
    }

    function escapeRegex(s){
      return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    /* ===== Sections/KPIs config ===== */
    function getSections(){
      return {
        "Pillar: Advancing Scientific Research":{
          milestones:["M1","M2","M3","M4","M5","M6","M7","M8","M9","M10.1","M10.2","M11"],
          description:"<strong>KPI:</strong> By 2029, enhance ONJCRI’s scientific research capacity by implementing advanced technologies, expanding research outputs, and developing innovative models to identify therapeutic targets and improve cancer outcomes."
        },
        "Pillar: Research Translation and Commercialisation":{
          milestones:["M12","M13","M14","M15","M16","M17","M18","M19"],
          description:"<strong>KPI:</strong> By 2029, advance research translation by developing multiple therapeutic candidates, progressing clinical trials, and securing commercial partnerships to ensure ONJCRI innovations reach patients."
        },
        "Pillar: Operational Excellence":{
          milestones:["M25","M26","M27","M28","M29","M30","M31","M32","M33","M34","M36","M37","M38","M39","M40","M42","M43"],
          description:"<strong>KPI:</strong> By 2029, optimise ONJCRI’s operational performance through enhanced governance, financial planning, branding, and stakeholder engagement to ensure long-term sustainability and global recognition."
        },
        "Pillar: Sustainability":{
          milestones:["M22","M23","M24","M35","M44"],
          description:"<strong>KPI:</strong> By 2029, embed sustainability principles across ONJCRI’s research and operations by reducing carbon emissions, increasing biobank diversity, and achieving full participation in equity initiatives."
        },
        "Pillar: Ethical and Regulatory Conduct":{
          milestones:["M20","M21","M41"],
          description:"<strong>KPI:</strong> By 2029, uphold the highest standards of ethics, governance, and regulatory compliance through continuous monitoring of research protocols, data security, and risk management frameworks."
        }
      };
    }

    /* ===== Rendering ===== */
    function milestoneAllActivitiesDone(name){
      const ms = originalData?.items?.find(i=>i.name===name);
      return !!(ms && ms.subitems.length>0 && ms.subitems.every(s=>(s.status||'').toLowerCase()==='done'));
    }

    function getMilestoneEmail(m){
      const emails={
        "M1":"onjcri_pulse_1987359246_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M2":"onjcri_pulse_1987359247_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M9":"onjcri_pulse_1987359248_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M10.1":"onjcri_pulse_1987359249_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M10.2":"onjcri_pulse_1987368440_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M7":"onjcri_pulse_1987359250_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M8":"onjcri_pulse_1987359251_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M3":"onjcri_pulse_1987359252_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M4":"onjcri_pulse_1987359253_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M5":"onjcri_pulse_1987359256_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M6":"onjcri_pulse_1987359257_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M11":"onjcri_pulse_1987359259_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M17":"onjcri_pulse_1987380037_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M18":"onjcri_pulse_1987380044_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M19":"onjcri_pulse_1987380051_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M14":"onjcri_pulse_1987380060_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M15":"onjcri_pulse_1987380065_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M16":"onjcri_pulse_1987380069_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M12":"onjcri_pulse_1987380073_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M13":"onjcri_pulse_1987380079_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M26":"onjcri_pulse_1987380673_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M36":"onjcri_pulse_1987380676_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M38":"onjcri_pulse_1987380678_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M39":"onjcri_pulse_1987380682_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M40":"onjcri_pulse_1987380684_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M42":"onjcri_pulse_1987380687_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M25":"onjcri_pulse_1987380689_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M27":"onjcri_pulse_1987380691_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M28":"onjcri_pulse_1987380694_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M30":"onjcri_pulse_1987380698_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M31":"onjcri_pulse_1987380701_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M32":"onjcri_pulse_1987380703_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M33":"onjcri_pulse_1987380705_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M29":"onjcri_pulse_1987380709_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M34":"onjcri_pulse_1987380710_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M43":"onjcri_pulse_1987380714_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M37":"onjcri_pulse_1987380719_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M44":"onjcri_pulse_1987381563_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M23":"onjcri_pulse_1987381569_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M35":"onjcri_pulse_1987381566_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M24":"onjcri_pulse_1987381579_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M22":"onjcri_pulse_1987381574_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M41":"onjcri_pulse_1987381253_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M20":"onjcri_pulse_1987381256_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M21":"onjcri_pulse_1987381262_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com"
      };
      return emails[m]||"impact@onjcri.org";
    }

    function renderSections(data){
      const container=document.getElementById('milestoneSections');
      container.innerHTML='';
      const sections=getSections();

      for(const [sectionTitle,{milestones,description}] of Object.entries(sections)){
        const itemsForSection=(data.items||[]).filter(i=>milestones.includes(i.name));
        if(itemsForSection.length===0) continue;

        const section=document.createElement('section');

        const headerContainer=document.createElement('div');
        headerContainer.className='section-heading-container collapsed';
        const arrow=document.createElement('span'); arrow.className='section-arrow'; arrow.textContent='▼';
        const heading=document.createElement('h2'); heading.className='section-heading'; heading.textContent=sectionTitle;
        headerContainer.appendChild(arrow); headerContainer.appendChild(heading);
        section.appendChild(headerContainer);

        const desc=document.createElement('p'); desc.className='section-description'; desc.innerHTML=description;
        section.appendChild(desc);

        // Progress bar
        const allSub=itemsForSection.flatMap(i=>i.subitems);
        const counts={done:0,working:0,stuck:0,pending:0};
        allSub.forEach(s=>{
          const st=(s.status||'').toLowerCase();
          if(st==='done') counts.done++;
          else if(st==='working on it') counts.working++;
          else if(st==='stuck') counts.stuck++;
          else counts.pending++;
        });
        const total=allSub.length||1;
        const pDone=100*counts.done/total, pWork=100*counts.working/total, pStuck=100*counts.stuck/total, pPend=100*counts.pending/total;
        const prog=document.createElement('div');
        prog.className='kpi-progress-container';
        prog.innerHTML=`
          <div class="progress-bar">
            <div class="bar-segment bar-done" style="width:${pDone}%"></div>
            <div class="bar-segment bar-working" style="width:${pWork}%"></div>
            <div class="bar-segment bar-stuck" style="width:${pStuck}%"></div>
            <div class="bar-segment bar-pending" style="width:${pPend}%"></div>
          </div>`;
        section.appendChild(prog);

        // Milestone list (collapsed)
        const listWrap=document.createElement('div'); listWrap.classList.add('hidden');
        const list=document.createElement('ul');

        itemsForSection.forEach((item,idx)=>{
          const li=document.createElement('li'); li.className='milestone-container'; li.id=item.name;
          const allDone = milestoneAllActivitiesDone(item.name);
          const badgeClass = allDone ? 'milestone-badge done' : 'milestone-badge';
          const sublistId = `${sectionTitle.replace(/\s+/g,'-')}-sub-${idx}`;
          const toggleId  = `${sectionTitle.replace(/\s+/g,'-')}-tog-${idx}`;
          const overdueTarget = item.date && isOverdue(item.date);

          const email = getMilestoneEmail(item.name);
          const emailBody = encodeURIComponent(`Dear ${item.name} Taskforce,\n\nI am writing regarding the progress of a strategic Milestone to which you have been assigned: ${item.description || "No description provided"}\n\n[Please add your specific question here].\n\nThank you,`);
          const mailto = `mailto:${email}?subject=${encodeURIComponent("Enquiry regarding " + item.name)}&body=${emailBody}`;

          const subHtml = item.subitems.map(sub=>{
            const s=(sub.status||'').toLowerCase();
            let cls='status-default', label='Unknown';
            if(s==='done'){cls='status-done';label='Done'}
            else if(s==='working on it'){cls='status-working';label='Working on It'}
            else if(s==='pending'){cls='status-pending';label='Pending'}
            else if(s==='stuck'){cls='status-stuck';label='Stuck'}
            const missingSponsor=!sub.sponsor, missingLead=!sub.lead, missingTimeline=!sub.timeline;
            const overdueClass=sub.timeline && isOverdue(sub.timeline.split('–').pop().trim()) && s!=='done' ? 'overdue' : (missingTimeline ? 'missing-data' : '');
            return `<li class="subitem">
              <div class="status-indicator ${cls}"></div>
              <div class="subitem-content">
                <span class="pill"><strong>Activity:</strong> ${escapeHtml(sub.name)}</span><br/>
                <span class="pill"><strong>Executive Sponsor(s):</strong> <span class="${missingSponsor?'missing-data':''}">${escapeHtml(sub.sponsor||'Not Assigned')}</span></span>
                <span class="pill"><strong>Operational Lead(s):</strong> <span class="${missingLead?'missing-data':''}">${escapeHtml(sub.lead||'Not Assigned')}</span></span>
                <span class="pill"><strong>Timeline:</strong> <span class="${overdueClass}">${escapeHtml(sub.timeline||'Missing')}</span></span>
              </div>
            </li>`;
          }).join('');

          li.innerHTML = `
            <div class="${badgeClass}">${item.name}</div>
            <div class="milestone-content">
              <div class="milestone-header">
                <span class="description">${escapeHtml(item.description||'No description provided.')}</span>
                <button class="email-taskforce-btn" onclick="window.location.href='${mailto}'">Email Taskforce</button>
              </div>
              ${(item.portfolio||item.date)?`
                <div class="metadata-line">
                  ${item.portfolio?`<span><strong>Executive Portfolio(s):</strong> ${escapeHtml(item.portfolio)}</span>`:''}
                  ${item.date?`<span><strong>Completion Target:</strong> <span class="${overdueTarget?'overdue':''}">${escapeHtml(item.date)}</span></span>`:''}
                </div>`:''}
              <div class="activity-summary">
                <div class="activity-toggle" id="${toggleId}"><span class="arrow">▼</span>${item.subitems.length} Activities</div>
                <div class="status-circles">
                  ${item.subitems.map(sub=>{
                    const s=(sub.status||'').toLowerCase();
                    let cls='pending';
                    if(s==='done') cls='done';
                    else if(s==='working on it') cls='working';
                    else if(s==='stuck') cls='stuck';
                    return `<div class="circle ${cls}"></div>`;
                  }).join('')}
                </div>
              </div>
              <ul id="${sublistId}" class="hidden sublist">${subHtml}</ul>
            </div>`;
          list.appendChild(li);
          li.querySelector('.activity-toggle').onclick=()=>toggleSublist(sublistId,toggleId);
        });

        listWrap.appendChild(list);
        section.appendChild(listWrap);

        headerContainer.onclick=()=>{
          const isHidden=listWrap.classList.toggle('hidden');
          headerContainer.classList.toggle('collapsed', isHidden);
        };

        container.appendChild(section);
      }
    }

    function toggleSublist(subId,togId){
      const ul=document.getElementById(subId);
      const tg=document.getElementById(togId);
      if(!ul||!tg) return;
      const hid=ul.classList.toggle('hidden');
      tg.classList.toggle('collapsed',hid);
    }
    function expandAll(){
      document.querySelectorAll('#milestoneSections section > div:nth-of-type(3)').forEach(w=>w.classList.remove('hidden'));
      document.querySelectorAll('.sublist').forEach(w=>w.classList.remove('hidden'));
      document.querySelectorAll('.activity-toggle').forEach(t=>t.classList.remove('collapsed'));
      document.querySelectorAll('.section-heading-container').forEach(h=>h.classList.remove('collapsed'));
    }
    function collapseAll(){
      document.querySelectorAll('#milestoneSections section > div:nth-of-type(3)').forEach(w=>w.classList.add('hidden'));
      document.querySelectorAll('.sublist').forEach(w=>w.classList.add('hidden'));
      document.querySelectorAll('.activity-toggle').forEach(t=>t.classList.add('collapsed'));
      document.querySelectorAll('.section-heading-container').forEach(h=>h.classList.add('collapsed'));
    }

    /* ===== Wire up search controls ===== */
    const $q = document.getElementById('searchInput');
    document.getElementById('searchBtn').addEventListener('click',()=>applySearch($q.value.trim()));
    document.getElementById('clearBtn').addEventListener('click',()=>{
      $q.value=''; lastQuery=''; applySearch('');
    });
    $q.addEventListener('keydown',e=>{
      if(e.key==='Enter'){ applySearch($q.value.trim()); }
    });

    /* ===== Kick off ===== */
    loadData();
  </script>
</body>
</html>
