<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>KPIs, Milestones, and associated Activities</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: #f7f9fb; color: #2b2b2b; margin: 0; padding: 40px; }
    h1 { font-size: 32px; font-weight: 700; margin-bottom: 16px; color: #103c60; border-bottom: 2px solid #d9e1ea; padding-bottom: 10px; }

    /* Search */
    .search-wrap { display: flex; gap: 10px; align-items: center; margin: 12px 0 20px; }
    .search-input {
      flex: 1; font-size: 14px; padding: 10px 12px; border: 1px solid #c9d6e2; border-radius: 6px; outline: none;
      background: #fff;
    }
    .search-input:focus { border-color: #6aa2e4; box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.15); }
    .clear-btn { display: none; }

    .refresh-container-top, .refresh-container { text-align: center; margin-top: 24px; }
    .refresh-btn { padding: 10px 20px; background-color: #0066cc; color: #fff; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: background 0.2s ease, transform 0.1s ease; margin: 0 5px;}
    .refresh-btn:hover { background-color: #004c99; }
    .refresh-btn:active { transform: scale(0.98); }

    /* Section headers (KPI pillars) */
    .section-heading-container { display: flex; align-items: center; gap: 8px; cursor: pointer; margin-top: 28px; padding-left: 10px; border-left: 5px solid #003e6b; }
    h2.section-heading { font-size: 20px; margin: 0; color: #003e6b; }
    .section-arrow { font-size: 16px; transition: transform 0.3s ease; color: #003e6b; }
    .collapsed .section-arrow { transform: rotate(-90deg); }
    .section-description { font-size: 14px; color: #444; margin: 8px 0 12px 6px; font-style: italic; max-width: 100%; }

    /* KPI progress bars */
    .kpi-progress-container { margin: 10px 0 20px 6px; position: relative; }
    .progress-bar { display: flex; height: 14px; border-radius: 7px; overflow: hidden; background: #e0e0e0; width: 100%; }
    .bar-segment { height: 100%; position: relative; cursor: pointer; transition: transform 0.2s ease; }
    .bar-done { background: #28a745; }
    .bar-working { background: #ffc107; }
    .bar-stuck { background: #dc3545; }
    .bar-pending { background: #6c757d; }

    /* Milestone cards */
    li.milestone-container { display: flex; position: relative; background-color: #fff; border: 1px solid #e0e4e8; border-radius: 10px; padding: 16px 18px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); }
    .milestone-badge { flex-shrink: 0; width: 50px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #003e6b; background: #f0f4f8; border-right: 2px solid #d1d9e0; border-radius: 8px 0 0 8px; box-shadow: inset -2px 0 5px rgba(0,0,0,0.05); writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg); font-size: 14px; letter-spacing: 1px; transition: background 0.3s ease, color 0.3s ease; }
    .milestone-badge.done { background: #28a745 !important; color: #fff !important; }

    .milestone-content { flex: 1; padding-left: 14px; display: flex; flex-direction: column; }
    .milestone-header { display: flex; flex-direction: row; align-items: flex-start; justify-content: space-between; margin-bottom: 6px; width: 100%; gap: 10px; }
    .description { font-style: italic; font-size: 14px; color: #555; white-space: normal; flex: 1; }

    .metadata-line { font-size: 13px; margin-top: 8px; padding: 6px 0; color: #333; display: flex; flex-wrap: wrap; gap: 20px; }
    .metadata-line strong { font-weight: 600; margin-right: 4px; }

    .activity-summary { display: flex; align-items: center; justify-content: space-between; margin: 8px 0 10px 0; }
    .activity-toggle { display: inline-flex; align-items: center; gap: 6px; font-size: 14px; color: #0066cc; cursor: pointer; user-select: none; }
    .activity-toggle:hover { text-decoration: underline; }
    .arrow { display: inline-block; transition: transform 0.3s ease; }
    .collapsed .arrow { transform: rotate(-90deg); }

    .status-circles { display: flex; gap: 4px; }
    .circle { width: 12px; height: 12px; border-radius: 50%; cursor: pointer; transition: transform 0.2s ease; }
    .circle:hover { animation: pulse 1.5s infinite; }
    .circle.done { background-color: #28a745; }
    .circle.working { background-color: #ffc107; }
    .circle.stuck { background-color: #dc3545; }
    .circle.pending { background-color: #6c757d; }

    .sublist { margin-top: 10px; list-style: none; padding-left: 0; }
    .subitem { padding: 14px 16px; border: 1px solid #d5dce1; border-radius: 10px; margin-bottom: 10px; font-size: 14px; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04); background: #f8fafc; display: flex; align-items: center; gap: 10px; }
    .status-indicator { width: 16px; height: 16px; border-radius: 50%; flex-shrink: 0; cursor: pointer; }
    .status-indicator:hover { animation: pulse 1.5s infinite; }

    @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0,0,0,0.2); } 50% { transform: scale(1.2); box-shadow: 0 0 6px rgba(0, 0, 0, 0.2); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0,0,0,0.2); } }

    .subitem-content { flex: 1; }
    .pill { display: inline-block; font-size: 13px; margin-top: 6px; margin-right: 12px; padding: 0; background-color: transparent; color: inherit; }
    .pill strong { font-weight: 600; margin-right: 4px; }
    .overdue { color: #ffffff; font-weight: 600; background: #dc3545; border-radius: 4px; padding: 1px 4px; cursor: pointer; }
    .missing-data { color: #ffffff; font-weight: 600; background: #ffc107; border-radius: 4px; padding: 1px 4px; cursor: pointer; }

    .status-done { background-color: #28a745; }
    .status-working { background-color: #ffc107; }
    .status-pending { background-color: #6c757d; }
    .status-stuck { background-color: #dc3545; }
    .status-default { background-color: #d5dce1; }

    .email-taskforce-btn { padding: 6px 12px; font-size: 12px; background: #0066cc; color: #fff; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap; }
    .email-taskforce-btn:hover { background: #004c99; }

    .hidden { display: none; }

    /* Overlay + tooltip */
    #loadingOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 20px; font-weight: bold; text-align: center; padding: 20px; }
    .pulse-word { animation: pulseImpact 1.5s infinite; color: #28a745; }
    @keyframes pulseImpact { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.3); opacity: 0.6; } 100% { transform: scale(1); opacity: 1; } }
    .tooltip { position: fixed; background: rgba(0, 0, 0, 0.8); color: #fff; padding: 6px 10px; font-size: 12px; border-radius: 4px; pointer-events: none; opacity: 0; transition: opacity 0.15s ease; z-index: 1000; }

    /* Highlight */
    mark.search-hit { background: #ffee93; padding: 0 2px; border-radius: 2px; }
    /* Empty state */
    .empty-state { margin: 24px 6px; padding: 16px; background: #f0f4f8; border: 1px solid #d9e1ea; border-radius: 8px; color: #003e6b; }
  </style>
</head>
<body>
  <h1>KPIs, Milestones, and associated Activities</h1>

  <!-- Search UI -->
  <div class="search-wrap">
    <input id="searchInput" class="search-input" type="search" placeholder="Search milestones, activities, sponsors, leads, timelinesâ€¦" autocomplete="off" />
    <button id="clearSearchBtn" class="refresh-btn clear-btn" title="Clear search">Clear</button>
  </div>

  <div class="refresh-container-top">
    <button class="refresh-btn" onclick="expandAll()">Expand All</button>
    <button class="refresh-btn" onclick="collapseAll()">Collapse All</button>
    <button class="refresh-btn" onclick="loadData()">Refresh Data</button>
  </div>

  <!-- CORE DATA ONLY -->
  <div id="milestoneSections"></div>

  <div class="refresh-container">
    <button class="refresh-btn" onclick="expandAll()">Expand All</button>
    <button class="refresh-btn" onclick="collapseAll()">Collapse All</button>
    <button class="refresh-btn" onclick="loadData()">Refresh Data</button>
  </div>

  <div id="loadingOverlay">Gathering <span class="pulse-word">IMPACT</span> data from ONJCRI...</div>
  <div class="tooltip" id="tooltip"></div>

  <script>
    const tooltip = document.getElementById('tooltip');
    const overlay = document.getElementById('loadingOverlay');
    const searchInput = document.getElementById('searchInput');
    const clearBtn = document.getElementById('clearSearchBtn');

    let originalData = null;
    let currentQuery = '';

    function showTooltip(text, x, y) { tooltip.textContent = text || ''; tooltip.style.left = x + 10 + 'px'; tooltip.style.top = y + 10 + 'px'; tooltip.style.opacity = 1; }
    function hideTooltip() { tooltip.style.opacity = 0; }

    function isOverdue(endDateStr) {
      if (!endDateStr) return false;
      const parts = endDateStr.split('/');
      if (parts.length !== 3) return false;
      const [day, month, year] = parts.map(Number);
      const endDate = new Date(year, month - 1, day);
      return endDate < new Date();
    }

    async function loadData() {
      overlay.style.display = 'flex';
      try {
        const res = await fetch('/api/milestones');
        const data = await res.json();
        if (!data.success) throw new Error(data.error || 'Unknown error');
        originalData = data;
        applySearch(''); // initial render
      } catch (err) {
        console.error(err);
      } finally {
        overlay.style.display = 'none';
      }
    }

    function expandAll() {
      document.querySelectorAll('#milestoneSections section > div:nth-of-type(3)').forEach(wrapper => wrapper.classList.remove('hidden'));
      document.querySelectorAll('.sublist').forEach(list => list.classList.remove('hidden'));
      document.querySelectorAll('.activity-toggle').forEach(toggle => toggle.classList.remove('collapsed'));
      document.querySelectorAll('.section-heading-container').forEach(header => header.classList.remove('collapsed'));
    }
    function collapseAll() {
      document.querySelectorAll('#milestoneSections section > div:nth-of-type(3)').forEach(wrapper => wrapper.classList.add('hidden'));
      document.querySelectorAll('.sublist').forEach(list => list.classList.add('hidden'));
      document.querySelectorAll('.activity-toggle').forEach(toggle => toggle.classList.add('collapsed'));
      document.querySelectorAll('.section-heading-container').forEach(header => header.classList.add('collapsed'));
    }

    function milestoneAllActivitiesDone(milestoneName) {
      const milestone = originalData.items.find(i => i.name === milestoneName);
      if (!milestone) return false;
      return milestone.subitems.length > 0 && milestone.subitems.every(sub => (sub.status || '').toLowerCase() === 'done');
    }

    function getSections() {
      return {
        "Pillar: Advancing Scientific Research": { milestones: ["M1","M2","M3","M4","M5","M6","M7","M8","M9","M10.1","M10.2","M11"], description: "<strong>KPI:</strong> By 2029, enhance ONJCRIâ€™s scientific research capacity by implementing advanced technologies, expanding research outputs, and developing innovative models to identify therapeutic targets and improve cancer outcomes." },
        "Pillar: Research Translation and Commercialisation": { milestones: ["M12","M13","M14","M15","M16","M17","M18","M19"], description: "<strong>KPI:</strong> By 2029, advance research translation by developing multiple therapeutic candidates, progressing clinical trials, and securing commercial partnerships to ensure ONJCRI innovations reach patients." },
        "Pillar: Operational Excellence": { milestones: ["M25","M26","M27","M28","M29","M30","M31","M32","M33","M34","M36","M37","M38","M39","M40","M42","M43"], description: "<strong>KPI:</strong> By 2029, optimise ONJCRIâ€™s operational performance through enhanced governance, financial planning, branding, and stakeholder engagement to ensure long-term sustainability and global recognition." },
        "Pillar: Sustainability": { milestones: ["M22","M23","M24","M35","M44"], description: "<strong>KPI:</strong> By 2029, embed sustainability principles across ONJCRIâ€™s research and operations by reducing carbon emissions, increasing biobank diversity, and achieving full participation in equity initiatives." },
        "Pillar: Ethical and Regulatory Conduct": { milestones: ["M20","M21","M41"], description: "<strong>KPI:</strong> By 2029, uphold the highest standards of ethics, governance, and regulatory compliance through continuous monitoring of research protocols, data security, and risk management frameworks." }
      };
    }

    function getMilestoneEmail(milestone) {
      const emails = {
        "M1":"onjcri_pulse_1987359246_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M2":"onjcri_pulse_1987359247_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M9":"onjcri_pulse_1987359248_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M10.1":"onjcri_pulse_1987359249_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M10.2":"onjcri_pulse_1987368440_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M7":"onjcri_pulse_1987359250_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M8":"onjcri_pulse_1987359251_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M3":"onjcri_pulse_1987359252_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M4":"onjcri_pulse_1987359253_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M5":"onjcri_pulse_1987359256_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M6":"onjcri_pulse_1987359257_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M11":"onjcri_pulse_1987359259_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M17":"onjcri_pulse_1987380037_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M18":"onjcri_pulse_1987380044_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M19":"onjcri_pulse_1987380051_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M14":"onjcri_pulse_1987380060_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M15":"onjcri_pulse_1987380065_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M16":"onjcri_pulse_1987380069_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M12":"onjcri_pulse_1987380073_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M13":"onjcri_pulse_1987380079_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M26":"onjcri_pulse_1987380673_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M36":"onjcri_pulse_1987380676_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M38":"onjcri_pulse_1987380678_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M39":"onjcri_pulse_1987380682_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M40":"onjcri_pulse_1987380684_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M42":"onjcri_pulse_1987380687_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M25":"onjcri_pulse_1987380689_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M27":"onjcri_pulse_1987380691_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M28":"onjcri_pulse_1987380694_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M30":"onjcri_pulse_1987380698_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M31":"onjcri_pulse_1987380701_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M32":"onjcri_pulse_1987380703_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M33":"onjcri_pulse_1987380705_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M29":"onjcri_pulse_1987380709_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M34":"onjcri_pulse_1987380710_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M43":"onjcri_pulse_1987380714_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M37":"onjcri_pulse_1987380719_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M44":"onjcri_pulse_1987381563_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M23":"onjcri_pulse_1987381569_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M35":"onjcri_pulse_1987381566_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M24":"onjcri_pulse_1987381579_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M22":"onjcri_pulse_1987381574_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M41":"onjcri_pulse_1987381253_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M20":"onjcri_pulse_1987381256_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M21":"onjcri_pulse_1987381262_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com"
      };
      return emails[milestone] || "default@onjcri.org";
    }

    /* ---------- SEARCH ---------- */

    function applySearch(q) {
      currentQuery = (q || '').trim();
      // Toggle clear button
      clearBtn.style.display = currentQuery ? 'inline-block' : 'none';

      if (!originalData) return;

      if (!currentQuery) {
        renderSections(originalData, null);
        return;
      }

      const query = currentQuery.toLowerCase();
      const filtered = { success: true, items: [] };

      originalData.items.forEach(item => {
        const itemText = [
          item.name || '',
          item.description || '',
          item.portfolio || '',
          item.date || ''
        ].join(' ').toLowerCase();

        const milestoneMatches = itemText.includes(query);

        // Filter subitems
        const matchedSubs = (item.subitems || []).filter(sub => {
          const subText = [
            sub.name || '',
            sub.status || '',
            sub.sponsor || '',
            sub.lead || '',
            sub.timeline || ''
          ].join(' ').toLowerCase();
          return subText.includes(query);
        });

        if (milestoneMatches) {
          // Keep all subitems if milestone matches
          filtered.items.push({ ...item, subitems: [...item.subitems] });
        } else if (matchedSubs.length > 0) {
          // Keep only matched subitems
          filtered.items.push({ ...item, subitems: matchedSubs });
        }
      });

      renderSections(filtered, query);
    }

    // Simple highlighter â€“ wrap matches in <mark>
    function highlight(text, query) {
      if (!query || !text) return text || '';
      try {
        const esc = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        return (text + '').replace(new RegExp(esc, 'ig'), m => `<mark class="search-hit">${m}</mark>`);
      } catch {
        return text;
      }
    }

    // Debounce helper
    function debounce(fn, ms) {
      let t; 
      return (...args) => { clearTimeout(t); t = setTimeout(() => fn.apply(this, args), ms); };
    }

    /* ---------- RENDERING ---------- */

    function renderSections(filteredData, highlightQuery = null) {
      const container = document.getElementById('milestoneSections');
      container.innerHTML = '';

      const sections = getSections();
      let anyContent = false;

      for (const [sectionTitle, { milestones, description }] of Object.entries(sections)) {
        const itemsForSection = filteredData.items.filter(i => milestones.includes(i.name));
        if (itemsForSection.length === 0) continue;
        anyContent = true;

        const section = document.createElement('section');

        // Header (collapsible)
        const headerContainer = document.createElement('div'); 
        headerContainer.className = 'section-heading-container collapsed';
        const arrow = document.createElement('span'); 
        arrow.className = 'section-arrow'; 
        arrow.textContent = 'â–¼';
        const heading = document.createElement('h2'); 
        heading.className = 'section-heading'; 
        heading.textContent = sectionTitle;
        headerContainer.appendChild(arrow); 
        headerContainer.appendChild(heading); 
        section.appendChild(headerContainer);

        // KPI description
        const desc = document.createElement('p'); 
        desc.className = 'section-description'; 
        desc.innerHTML = description; 
        section.appendChild(desc);

        // Progress bar (based on activities across milestones in this section)
        const allSubitems = itemsForSection.flatMap(i => i.subitems);
        const counts = { done: 0, working: 0, stuck: 0, pending: 0 };
        allSubitems.forEach(sub => {
          const s = (sub.status || '').toLowerCase();
          if (s === 'done') counts.done++;
          else if (s === 'working on it') counts.working++;
          else if (s === 'stuck') counts.stuck++;
          else counts.pending++;
        });
        const total = allSubitems.length || 1;
        const donePct = (counts.done / total) * 100, 
              workingPct = (counts.working / total) * 100, 
              stuckPct = (counts.stuck / total) * 100, 
              pendingPct = (counts.pending / total) * 100;

        const progressContainer = document.createElement('div');
        progressContainer.className = 'kpi-progress-container';
        progressContainer.innerHTML = `
          <div class="progress-bar">
            <div class="bar-segment bar-done" style="width:${donePct}%" data-status="Done: ${counts.done} Activities"></div>
            <div class="bar-segment bar-working" style="width:${workingPct}%" data-status="Working on It: ${counts.working} Activities"></div>
            <div class="bar-segment bar-stuck" style="width:${stuckPct}%" data-status="Stuck: ${counts.stuck} Activities"></div>
            <div class="bar-segment bar-pending" style="width:${pendingPct}%" data-status="Pending: ${counts.pending} Activities"></div>
          </div>`;
        section.appendChild(progressContainer);

        // Milestone list (collapsed by default)
        const listWrapper = document.createElement('div'); 
        listWrapper.classList.add('hidden');
        const list = document.createElement('ul'); 
        list.style.listStyle = 'none'; 
        list.style.paddingLeft = '0';

        itemsForSection.forEach((item, index) => {
          const li = document.createElement('li');
          li.className = 'milestone-container';
          li.id = item.name;

          const allDone = milestoneAllActivitiesDone(item.name);
          const badgeClass = allDone ? 'milestone-badge done' : 'milestone-badge';
          const sublistId = `${sectionTitle.replace(/\s+/g, '-')}-sublist-${index}`;
          const toggleId = `${sectionTitle.replace(/\s+/g, '-')}-toggle-${index}`;
          const completionTargetOverdue = item.date && isOverdue(item.date);

          // Email link
          const email = getMilestoneEmail(item.name);
          const emailBody = encodeURIComponent(
            `Dear ${item.name} Taskforce,\n\n` +
            `I am writing regarding the progress of a strategic Milestone to which you have been assigned: ${item.description || "No description provided"}\n\n` +
            `[Please add your specific question here].\n\nThank you,`
          );
          const mailtoLink = `mailto:${email}?subject=${encodeURIComponent("Enquiry regarding " + item.name)}&body=${emailBody}`;

          // Activities list (subitems)
          const subitemsHtml = item.subitems.map(sub => {
            const s = (sub.status || '').toLowerCase();
            let statusClass = 'status-default', statusText = 'Unknown';
            if (s === 'done') { statusClass = 'status-done'; statusText = 'Done'; }
            else if (s === 'working on it') { statusClass = 'status-working'; statusText = 'Working on It'; }
            else if (s === 'pending') { statusClass = 'status-pending'; statusText = 'Pending'; }
            else if (s === 'stuck') { statusClass = 'status-stuck'; statusText = 'Stuck'; }

            const missingSponsor = !sub.sponsor;
            const missingLead = !sub.lead;
            const missingTimeline = !sub.timeline;
            const overdueClass = sub.timeline && isOverdue(sub.timeline.split('â€“').pop().trim()) && s !== 'done'
              ? 'overdue'
              : (missingTimeline ? 'missing-data' : '');

            return `<li class="subitem">
                      <div class="status-indicator ${statusClass}" data-status="${statusText}"></div>
                      <div class="subitem-content">
                        <span class="pill"><strong>Activity:</strong> ${highlight(sub.name, highlightQuery)}</span><br/>
                        <span class="pill"><strong>Executive Sponsor(s):</strong> <span class="${missingSponsor ? 'missing-data' : ''}">${highlight(sub.sponsor || 'Not Assigned', highlightQuery)}</span></span>
                        <span class="pill"><strong>Operational Lead(s):</strong> <span class="${missingLead ? 'missing-data' : ''}">${highlight(sub.lead || 'Not Assigned', highlightQuery)}</span></span>
                        <span class="pill"><strong>Timeline:</strong> <span class="${overdueClass}">${highlight(sub.timeline || 'Missing', highlightQuery)}</span></span>
                      </div>
                    </li>`;
          }).join('');

          const descHtml = highlight(item.description || 'No description provided.', highlightQuery);
          const portfolioHtml = item.portfolio ? `<span><strong>Executive Portfolio(s):</strong> ${highlight(item.portfolio, highlightQuery)}</span>` : '';
          const dateHtml = item.date ? `<span><strong>Completion Target:</strong> <span class="${completionTargetOverdue ? 'overdue' : ''}">${highlight(item.date, highlightQuery)}</span></span>` : '';

          li.innerHTML = `
            <div class="${badgeClass}">${highlight(item.name, highlightQuery)}</div>
            <div class="milestone-content">
              <div class="milestone-header">
                <span class="description">${descHtml}</span>
                <button class="email-taskforce-btn" onclick="window.location.href='${mailtoLink}'" data-status="Email Taskforce for ${item.name}">Email Taskforce</button>
              </div>
              ${(portfolioHtml || dateHtml) ? `<div class="metadata-line">${portfolioHtml}${dateHtml}</div>` : ''}
              <div class="activity-summary">
                <div class="activity-toggle" id="${toggleId}">
                  <span class="arrow">â–¼</span>${item.subitems.length} Activities
                </div>
                <div class="status-circles">
                  ${item.subitems.map(sub => {
                    const s = (sub.status || '').toLowerCase();
                    let cls = 'pending', label = 'Pending';
                    if (s === 'done') { cls = 'done'; label = 'Done'; }
                    else if (s === 'working on it') { cls = 'working'; label = 'Working on It'; }
                    else if (s === 'stuck') { cls = 'stuck'; label = 'Stuck'; }
                    return `<div class="circle ${cls}" data-status="${label}"></div>`;
                  }).join('')}
                </div>
              </div>
              <ul id="${sublistId}" class="hidden sublist">${subitemsHtml}</ul>
            </div>`;

          list.appendChild(li);
          li.querySelector('.activity-toggle').onclick = () => toggleSublist(sublistId, toggleId);
        });

        listWrapper.appendChild(list);
        section.appendChild(listWrapper);

        // Section collapse toggle
        headerContainer.onclick = () => {
          const isHidden = listWrapper.classList.toggle('hidden');
          headerContainer.classList.toggle('collapsed', isHidden);
        };

        container.appendChild(section);
      }

      if (!anyContent) {
        const empty = document.createElement('div');
        empty.className = 'empty-state';
        empty.innerHTML = `No results for <strong>${currentQuery.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</strong>. Try a different search.`;
        container.appendChild(empty);
      }

      // Tooltips for little indicators & buttons
      document.querySelectorAll('.status-indicator, .status-circles .circle, .bar-segment, .email-taskforce-btn').forEach(el => {
        el.addEventListener('mousemove', e => showTooltip(el.dataset.status || '', e.clientX, e.clientY));
        el.addEventListener('mouseleave', hideTooltip);
      });
    }

    function toggleSublist(sublistId, toggleId) {
      const sublist = document.getElementById(sublistId);
      const toggle = document.getElementById(toggleId);
      if (!sublist || !toggle) return;
      const isHidden = sublist.classList.toggle('hidden');
      toggle.classList.toggle('collapsed', isHidden);
    }

    /* Wire up search */
    const onSearchInput = debounce(() => applySearch(searchInput.value), 250);
    searchInput.addEventListener('input', onSearchInput);
    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        searchInput.value = '';
        applySearch('');
        searchInput.blur();
      }
    });
    clearBtn.addEventListener('click', () => {
      searchInput.value = '';
      applySearch('');
      searchInput.focus();
    });

    // Kick things off
    loadData();
  </script>
</body>
</html>
