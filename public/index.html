<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>KPIs, Milestones, and associated Activities</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: #f7f9fb; color: #2b2b2b; margin: 0; padding: 40px; }
    h1 { font-size: 32px; font-weight: 700; margin-bottom: 16px; color: #103c60; border-bottom: 2px solid #d9e1ea; padding-bottom: 10px; }

    .search-row { display: flex; gap: 8px; align-items: center; }
    #searchInput { flex: 1; padding: 10px 12px; border: 1px solid #cfd8e3; border-radius: 6px; font-size: 14px; }
    .btn { padding: 9px 14px; background-color: #0b62cc; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
    .btn.secondary { background: #6b7280; }
    .btn:hover { filter: brightness(0.95); }

    .tip { font-size: 12px; color: #556; margin: 8px 0 14px; }
    .callout { background: #eef5ff; border: 1px solid #cfe1ff; padding: 12px 14px; border-radius: 8px; margin: 6px 0 18px; }
    .pdf-title { font-weight: 700; color: #103c60; margin-bottom: 6px; }
    .pdf-hits { margin: 6px 0 0; padding-left: 18px; }
    .pdf-hit { margin: 4px 0; }
    .hint { color: #334155; font-size: 14px; }
    .pdf-open { margin-top: 8px; }

    .refresh-container-top, .refresh-container { text-align: center; margin-top: 20px; }
    .refresh-btn { padding: 10px 20px; background-color: #0066cc; color: #fff; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: background 0.2s ease, transform 0.1s ease; margin: 0 5px;}
    .refresh-btn:hover { background-color: #004c99; }
    .refresh-btn:active { transform: scale(0.98); }

    .section-heading-container { display: flex; align-items: center; gap: 8px; cursor: pointer; margin-top: 28px; padding-left: 10px; border-left: 5px solid #003e6b; }
    h2.section-heading { font-size: 20px; margin: 0; color: #003e6b; }
    .section-arrow { font-size: 16px; transition: transform 0.3s ease; color: #003e6b; }
    .collapsed .section-arrow { transform: rotate(-90deg); }
    .section-description { font-size: 14px; color: #444; margin: 8px 0 12px 6px; font-style: italic; }

    .kpi-progress-container { margin: 10px 0 20px 6px; position: relative; }
    .progress-bar { display: flex; height: 14px; border-radius: 7px; overflow: hidden; background: #e0e0e0; width: 100%; }
    .bar-segment { height: 100%; }
    .bar-done { background: #28a745; } .bar-working { background: #ffc107; } .bar-stuck { background: #dc3545; } .bar-pending { background: #6c757d; }

    li.milestone-container { display: flex; background: #fff; border: 1px solid #e0e4e8; border-radius: 10px; padding: 16px 18px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .milestone-badge { flex-shrink: 0; width: 50px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #003e6b; background: #f0f4f8; border-right: 2px solid #d1d9e0; border-radius: 8px 0 0 8px; writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg); font-size: 14px; }
    .milestone-badge.done { background: #28a745; color: #fff; }

    .milestone-content { flex: 1; padding-left: 14px; display: flex; flex-direction: column; }
    .milestone-header { display: flex; align-items: flex-start; justify-content: space-between; gap: 10px; margin-bottom: 6px; }
    .description { font-style: italic; font-size: 14px; color: #555; flex: 1; }

    .metadata-line { font-size: 13px; margin-top: 8px; padding: 6px 0; color: #333; display: flex; flex-wrap: wrap; gap: 20px; }
    .metadata-line strong { font-weight: 600; margin-right: 4px; }

    .activity-summary { display: flex; align-items: center; justify-content: space-between; margin: 8px 0 10px; }
    .activity-toggle { display: inline-flex; align-items: center; gap: 6px; font-size: 14px; color: #0066cc; cursor: pointer; user-select: none; }
    .arrow { display: inline-block; transition: transform 0.3s ease; }
    .collapsed .arrow { transform: rotate(-90deg); }

    .status-circles { display: flex; gap: 4px; }
    .circle { width: 12px; height: 12px; border-radius: 50%; }
    .circle.done { background-color: #28a745; } .circle.working { background-color: #ffc107; } .circle.stuck { background-color: #dc3545; } .circle.pending { background-color: #6c757d; }

    .sublist { margin-top: 10px; list-style: none; padding-left: 0; }
    .subitem { padding: 14px 16px; border: 1px solid #d5dce1; border-radius: 10px; margin-bottom: 10px; font-size: 14px; background: #f8fafc; display: flex; align-items: center; gap: 10px; }
    .status-indicator { width: 16px; height: 16px; border-radius: 50%; flex-shrink: 0; }
    .status-done { background-color: #28a745; } .status-working { background-color: #ffc107; } .status-pending { background-color: #6c757d; } .status-stuck { background-color: #dc3545; }
    .subitem-content { flex: 1; }
    .pill { display: inline-block; font-size: 13px; margin-top: 6px; margin-right: 12px; }
    .overdue { color: #fff; font-weight: 600; background: #dc3545; border-radius: 4px; padding: 1px 4px; }
    .missing-data { color: #fff; font-weight: 600; background: #ffc107; border-radius: 4px; padding: 1px 4px; }

    .hidden { display: none; }

    #loadingOverlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 18px; font-weight: bold; }
    .pulse-word { animation: pulseImpact 1.5s infinite; color: #28a745; }
    @keyframes pulseImpact { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.3); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }
  </style>
</head>
<body>
  <h1>KPIs, Milestones, and associated Activities</h1>

  <!-- Search -->
  <div class="search-row">
    <input id="searchInput" type="text" placeholder="Search pillars, KPIs, milestones, activities…" />
    <button id="searchBtn" class="btn">Search</button>
    <button id="clearBtn" class="btn secondary">Clear</button>
  </div>
  <div class="tip">Tip: try terms like <em>CRISPR</em>, <em>genomics</em>, <em>clinical trial</em>, etc.</div>

  <!-- Strategy matches area -->
  <div id="strategyMatches" class="callout"></div>

  <!-- Controls -->
  <div class="refresh-container-top">
    <button class="refresh-btn" onclick="expandAll()">Expand All</button>
    <button class="refresh-btn" onclick="collapseAll()">Collapse All</button>
    <button class="refresh-btn" onclick="loadData()">Refresh Data</button>
  </div>

  <!-- CORE DATA -->
  <div id="milestoneSections"></div>

  <div class="refresh-container">
    <button class="refresh-btn" onclick="expandAll()">Expand All</button>
    <button class="refresh-btn" onclick="collapseAll()">Collapse All</button>
    <button class="refresh-btn" onclick="loadData()">Refresh Data</button>
  </div>

  <div id="loadingOverlay">Gathering <span class="pulse-word">IMPACT</span> data from ONJCRI…</div>

  <script>
    const STRATEGY_PDF_URL = 'https://www.onjcri.org.au/wp-content/uploads/2025/06/ONJCRI_Impact-Strategy_16-page_WEB.pdf';

    const overlay = document.getElementById('loadingOverlay');
    let originalData = null;
    let currentSearch = '';

    function isOverdue(endDateStr) {
      if (!endDateStr) return false;
      const parts = endDateStr.split('/');
      if (parts.length !== 3) return false;
      const [d,m,y] = parts.map(Number);
      const endDate = new Date(y, m - 1, d);
      return endDate < new Date();
    }

    async function loadData() {
      overlay.style.display = 'flex';
      try {
        const res = await fetch('/api/milestones');
        const data = await res.json();
        if (!data.success) throw new Error(data.error || 'Unknown error');
        originalData = data;
        applySearch(currentSearch);
      } catch (err) {
        console.error(err);
      } finally {
        overlay.style.display = 'none';
      }
    }

    function expandAll() {
      document.querySelectorAll('#milestoneSections section > div:nth-of-type(3)').forEach(w => w.classList.remove('hidden'));
      document.querySelectorAll('.sublist').forEach(list => list.classList.remove('hidden'));
      document.querySelectorAll('.activity-toggle').forEach(t => t.classList.remove('collapsed'));
      document.querySelectorAll('.section-heading-container').forEach(h => h.classList.remove('collapsed'));
    }
    function collapseAll() {
      document.querySelectorAll('#milestoneSections section > div:nth-of-type(3)').forEach(w => w.classList.add('hidden'));
      document.querySelectorAll('.sublist').forEach(list => list.classList.add('hidden'));
      document.querySelectorAll('.activity-toggle').forEach(t => t.classList.add('collapsed'));
      document.querySelectorAll('.section-heading-container').forEach(h => h.classList.add('collapsed'));
    }

    function milestoneAllActivitiesDone(milestoneName) {
      const m = originalData?.items?.find(i => i.name === milestoneName);
      if (!m) return false;
      return m.subitems.length > 0 && m.subitems.every(s => (s.status || '').toLowerCase() === 'done');
    }

    function getSections() {
      return {
        "Pillar: Advancing Scientific Research": { milestones: ["M1","M2","M3","M4","M5","M6","M7","M8","M9","M10.1","M10.2","M11"], description: "<strong>KPI:</strong> By 2029, enhance ONJCRI’s scientific research capacity by implementing advanced technologies, expanding research outputs, and developing innovative models to identify therapeutic targets and improve cancer outcomes." },
        "Pillar: Research Translation and Commercialisation": { milestones: ["M12","M13","M14","M15","M16","M17","M18","M19"], description: "<strong>KPI:</strong> By 2029, advance research translation by developing multiple therapeutic candidates, progressing clinical trials, and securing commercial partnerships to ensure ONJCRI innovations reach patients." },
        "Pillar: Operational Excellence": { milestones: ["M25","M26","M27","M28","M29","M30","M31","M32","M33","M34","M36","M37","M38","M39","M40","M42","M43"], description: "<strong>KPI:</strong> By 2029, optimise ONJCRI’s operational performance through enhanced governance, financial planning, branding, and stakeholder engagement to ensure long-term sustainability and global recognition." },
        "Pillar: Sustainability": { milestones: ["M22","M23","M24","M35","M44"], description: "<strong>KPI:</strong> By 2029, embed sustainability principles across ONJCRI’s research and operations by reducing carbon emissions, increasing biobank diversity, and achieving full participation in equity initiatives." },
        "Pillar: Ethical and Regulatory Conduct": { milestones: ["M20","M21","M41"], description: "<strong>KPI:</strong> By 2029, uphold the highest standards of ethics, governance, and regulatory compliance through continuous monitoring of research protocols, data security, and risk management frameworks." }
      };
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    /* ---------- Search across your data ---------- */
    function applySearch(term) {
      if (!originalData) return;
      term = (term || '').trim();
      if (!term) {
        renderSections(originalData);
        document.getElementById('strategyMatches').innerHTML = '';
        return;
      }

      const q = term.toLowerCase();
      const filtered = {
        success: true,
        items: originalData.items.map(it => {
          const matchItem =
            it.name?.toLowerCase().includes(q) ||
            it.description?.toLowerCase().includes(q) ||
            it.portfolio?.toLowerCase().includes(q) ||
            it.date?.toLowerCase().includes(q);

          const subitems = (it.subitems || []).filter(sub =>
            sub.name?.toLowerCase().includes(q) ||
            sub.status?.toLowerCase().includes(q) ||
            sub.sponsor?.toLowerCase().includes(q) ||
            sub.lead?.toLowerCase().includes(q) ||
            sub.timeline?.toLowerCase().includes(q)
          );

          if (matchItem || subitems.length > 0) {
            return { ...it, subitems };
          }
          return null;
        }).filter(Boolean)
      };

      renderSections(filtered);
      searchStrategyMatches(term); // also search the PDF
    }

    /* ---------- Server-side PDF search ---------- */
    async function searchStrategyMatches(query) {
      const box = document.getElementById('strategyMatches');
      if (!query || !STRATEGY_PDF_URL) {
        box.innerHTML = '';
        return;
      }
      box.innerHTML = `<div class="pdf-title">Strategy matches</div><div class="hint">Searching Strategy PDF…</div>`;

      try {
        const resp = await fetch(`/api/pdf-search?url=${encodeURIComponent(STRATEGY_PDF_URL)}&q=${encodeURIComponent(query)}`);
        const json = await resp.json();

        if (!json.success) {
          box.innerHTML = `<div class="pdf-title">Strategy matches</div>
            <div class="hint">Cannot search the PDF right now. <a href="${STRATEGY_PDF_URL}" target="_blank" rel="noopener">Open PDF</a></div>`;
          return;
        }

        if (!json.matches || json.matches.length === 0) {
          box.innerHTML = `<div class="pdf-title">Strategy matches</div>
            <div class="hint">No mentions found. <a href="${STRATEGY_PDF_URL}" target="_blank" rel="noopener">Open PDF</a></div>`;
          return;
        }

        const list = json.matches.map(m => `<li class="pdf-hit">… ${escapeHtml(m.snippet)} …</li>`).join('');
        box.innerHTML = `
          <div class="pdf-title">Strategy matches</div>
          <ul class="pdf-hits">${list}</ul>
          <div class="pdf-open"><a href="${STRATEGY_PDF_URL}" target="_blank" rel="noopener">Open PDF</a></div>
        `;
      } catch {
        box.innerHTML = `<div class="pdf-title">Strategy matches</div>
          <div class="hint">Cannot search the PDF right now. <a href="${STRATEGY_PDF_URL}" target="_blank" rel="noopener">Open PDF</a></div>`;
      }
    }

    /* ---------- Rendering ---------- */
    function renderSections(data) {
      const container = document.getElementById('milestoneSections');
      container.innerHTML = '';
      const sections = getSections();

      for (const [sectionTitle, { milestones, description }] of Object.entries(sections)) {
        const itemsForSection = data.items.filter(i => milestones.includes(i.name));
        if (itemsForSection.length === 0) continue;

        const section = document.createElement('section');

        // Collapsible header
        const headerContainer = document.createElement('div');
        headerContainer.className = 'section-heading-container collapsed';
        const arrow = document.createElement('span');
        arrow.className = 'section-arrow';
        arrow.textContent = '▼';
        const heading = document.createElement('h2');
        heading.className = 'section-heading';
        heading.textContent = sectionTitle;
        headerContainer.appendChild(arrow); headerContainer.appendChild(heading);
        section.appendChild(headerContainer);

        const desc = document.createElement('p');
        desc.className = 'section-description';
        desc.innerHTML = description;
        section.appendChild(desc);

        // Progress bar for the section
        const allSubitems = itemsForSection.flatMap(i => i.subitems);
        const counts = { done: 0, working: 0, stuck: 0, pending: 0 };
        allSubitems.forEach(sub => {
          const s = (sub.status || '').toLowerCase();
          if (s === 'done') counts.done++;
          else if (s === 'working on it') counts.working++;
          else if (s === 'stuck') counts.stuck++;
          else counts.pending++;
        });
        const total = allSubitems.length || 1;
        const donePct = (counts.done / total) * 100,
              workingPct = (counts.working / total) * 100,
              stuckPct = (counts.stuck / total) * 100,
              pendingPct = (counts.pending / total) * 100;

        const progressContainer = document.createElement('div');
        progressContainer.className = 'kpi-progress-container';
        progressContainer.innerHTML = `
          <div class="progress-bar">
            <div class="bar-segment bar-done" style="width:${donePct}%"></div>
            <div class="bar-segment bar-working" style="width:${workingPct}%"></div>
            <div class="bar-segment bar-stuck" style="width:${stuckPct}%"></div>
            <div class="bar-segment bar-pending" style="width:${pendingPct}%"></div>
          </div>`;
        section.appendChild(progressContainer);

        // Milestone list (collapsed by default)
        const listWrapper = document.createElement('div'); 
        listWrapper.classList.add('hidden');
        const list = document.createElement('ul'); 
        list.style.listStyle = 'none'; 
        list.style.paddingLeft = '0';

        itemsForSection.forEach((item, index) => {
          const li = document.createElement('li');
          li.className = 'milestone-container';
          li.id = item.name;

          const allDone = milestoneAllActivitiesDone(item.name);
          const badgeClass = allDone ? 'milestone-badge done' : 'milestone-badge';
          const sublistId = `${sectionTitle.replace(/\s+/g, '-')}-sublist-${index}`;
          const toggleId = `${sectionTitle.replace(/\s+/g, '-')}-toggle-${index}`;
          const completionTargetOverdue = item.date && isOverdue(item.date);

          const subitemsHtml = item.subitems.map(sub => {
            const s = (sub.status || '').toLowerCase();
            let statusClass = 'status-pending', statusText = 'Pending';
            if (s === 'done') { statusClass = 'status-done'; statusText = 'Done'; }
            else if (s === 'working on it') { statusClass = 'status-working'; statusText = 'Working on It'; }
            else if (s === 'stuck') { statusClass = 'status-stuck'; statusText = 'Stuck'; }

            const missingSponsor = !sub.sponsor;
            const missingLead = !sub.lead;
            const missingTimeline = !sub.timeline;
            const overdueClass = sub.timeline && isOverdue(sub.timeline.split('–').pop().trim()) && s !== 'done'
              ? 'overdue'
              : (missingTimeline ? 'missing-data' : '');

            return `<li class="subitem">
                      <div class="status-indicator ${statusClass}" title="${statusText}"></div>
                      <div class="subitem-content">
                        <span class="pill"><strong>Activity:</strong> ${escapeHtml(sub.name)}</span><br/>
                        <span class="pill"><strong>Executive Sponsor(s):</strong> <span class="${missingSponsor ? 'missing-data' : ''}">${escapeHtml(sub.sponsor || 'Not Assigned')}</span></span>
                        <span class="pill"><strong>Operational Lead(s):</strong> <span class="${missingLead ? 'missing-data' : ''}">${escapeHtml(sub.lead || 'Not Assigned')}</span></span>
                        <span class="pill"><strong>Timeline:</strong> <span class="${overdueClass}">${escapeHtml(sub.timeline || 'Missing')}</span></span>
                      </div>
                    </li>`;
          }).join('');

          li.innerHTML = `
            <div class="${badgeClass}">${escapeHtml(item.name)}</div>
            <div class="milestone-content">
              <div class="milestone-header">
                <span class="description">${escapeHtml(item.description || 'No description provided.')}</span>
              </div>
              ${item.portfolio || item.date ? `<div class="metadata-line">
                ${item.portfolio ? `<span><strong>Executive Portfolio(s):</strong> ${escapeHtml(item.portfolio)}</span>` : ''}
                ${item.date ? `<span><strong>Completion Target:</strong> <span class="${completionTargetOverdue ? 'overdue' : ''}">${escapeHtml(item.date)}</span></span>` : ''}
              </div>` : ''}
              <div class="activity-summary">
                <div class="activity-toggle" id="${toggleId}">
                  <span class="arrow">▼</span>${item.subitems.length} Activities
                </div>
                <div class="status-circles">
                  ${item.subitems.map(sub => {
                    const s = (sub.status || '').toLowerCase();
                    let cls = 'pending';
                    if (s === 'done') cls = 'done';
                    else if (s === 'working on it') cls = 'working';
                    else if (s === 'stuck') cls = 'stuck';
                    return `<div class="circle ${cls}"></div>`;
                  }).join('')}
                </div>
              </div>
              <ul id="${sublistId}" class="hidden sublist">${subitemsHtml}</ul>
            </div>`;

          list.appendChild(li);
          li.querySelector('.activity-toggle').onclick = () => {
            const sublist = document.getElementById(sublistId);
            const toggle = document.getElementById(toggleId);
            const hidden = sublist.classList.toggle('hidden');
            toggle.classList.toggle('collapsed', hidden);
          };
        });

        listWrapper.appendChild(list);
        section.appendChild(listWrapper);

        headerContainer.onclick = () => {
          const hidden = listWrapper.classList.toggle('hidden');
          headerContainer.classList.toggle('collapsed', hidden);
        };

        container.appendChild(section);
      }
    }

    /* ---------- wire up search ---------- */
    document.getElementById('searchBtn').addEventListener('click', () => {
      currentSearch = document.getElementById('searchInput').value || '';
      applySearch(currentSearch);
    });
    document.getElementById('clearBtn').addEventListener('click', () => {
      document.getElementById('searchInput').value = '';
      currentSearch = '';
      applySearch('');
    });
    document.getElementById('searchInput').addEventListener('keydown', e => {
      if (e.key === 'Enter') document.getElementById('searchBtn').click();
    });

    // initial load
    loadData();
  </script>
</body>
</html>
