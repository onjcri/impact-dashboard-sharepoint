<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>KPIs, Milestones, and associated Activities</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: #f7f9fb; color: #2b2b2b; margin: 0; padding: 40px; }
    h1 { font-size: 32px; font-weight: 700; margin-bottom: 16px; color: #103c60; border-bottom: 2px solid #d9e1ea; padding-bottom: 10px; }

    /* Search */
    .search-row { display: flex; gap: 8px; align-items: center; margin: 16px 0 8px; }
    .search-input { flex: 1; height: 40px; border: 1px solid #c9d6e2; border-radius: 8px; padding: 0 12px; font-size: 14px; }
    .search-btn, .clear-btn { padding: 10px 14px; background-color: #0066cc; color: #fff; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: background 0.2s ease, transform 0.1s ease; }
    .clear-btn { background-color: #6c757d; }
    .search-btn:hover { background-color: #004c99; }
    .clear-btn:hover { background-color: #565e64; }
    .search-btn:active, .clear-btn:active { transform: scale(0.98); }
    .search-hint { font-size: 12px; color: #4a5b6f; margin-bottom: 8px; }

    /* Results summary for strategy */
    .strategy-results { background: #eef5fb; border: 1px solid #cfe1f1; border-radius: 8px; padding: 12px 14px; margin: 8px 0 18px; }
    .strategy-results h3 { margin: 0 0 8px; font-size: 16px; color: #003e6b; }
    .strategy-hit { padding: 8px 10px; border-radius: 6px; border: 1px solid #e0e7ef; background: #fff; margin-bottom: 8px; }
    .hit-title { font-weight: 600; color: #103c60; }
    .hit-meta { font-size: 12px; color: #506070; margin-left: 6px; }
    .hit-snippet { font-size: 13px; margin-top: 4px; color: #2b2b2b; }
    mark { background: #fff19e; padding: 0 2px; border-radius: 2px; }

    .refresh-container-top, .refresh-container { text-align: center; margin-top: 24px; }
    .refresh-btn { padding: 10px 20px; background-color: #0066cc; color: #fff; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: background 0.2s ease, transform 0.1s ease; margin: 0 5px;}
    .refresh-btn:hover { background-color: #004c99; }
    .refresh-btn:active { transform: scale(0.98); }

    /* Section headers (KPI pillars) */
    .section-heading-container { display: flex; align-items: center; gap: 8px; cursor: pointer; margin-top: 28px; padding-left: 10px; border-left: 5px solid #003e6b; }
    h2.section-heading { font-size: 20px; margin: 0; color: #003e6b; }
    .section-arrow { font-size: 16px; transition: transform 0.3s ease; color: #003e6b; }
    .collapsed .section-arrow { transform: rotate(-90deg); }
    .section-description { font-size: 14px; color: #444; margin: 8px 0 12px 6px; font-style: italic; max-width: 100%; }

    /* KPI progress bars */
    .kpi-progress-container { margin: 10px 0 20px 6px; position: relative; }
    .progress-bar { display: flex; height: 14px; border-radius: 7px; overflow: hidden; background: #e0e0e0; width: 100%; }
    .bar-segment { height: 100%; position: relative; cursor: pointer; transition: transform 0.2s ease; }
    .bar-done { background: #28a745; }
    .bar-working { background: #ffc107; }
    .bar-stuck { background: #dc3545; }
    .bar-pending { background: #6c757d; }

    /* Milestone cards */
    li.milestone-container { display: flex; position: relative; background-color: #fff; border: 1px solid #e0e4e8; border-radius: 10px; padding: 16px 18px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); }
    .milestone-badge { flex-shrink: 0; width: 50px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #003e6b; background: #f0f4f8; border-right: 2px solid #d1d9e0; border-radius: 8px 0 0 8px; box-shadow: inset -2px 0 5px rgba(0,0,0,0.05); writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg); font-size: 14px; letter-spacing: 1px; transition: background 0.3s ease, color 0.3s ease; }
    .milestone-badge.done { background: #28a745 !important; color: #fff !important; }

    .milestone-content { flex: 1; padding-left: 14px; display: flex; flex-direction: column; }
    .milestone-header { display: flex; flex-direction: row; align-items: flex-start; justify-content: space-between; margin-bottom: 6px; width: 100%; gap: 10px; }
    .description { font-style: italic; font-size: 14px; color: #555; white-space: normal; flex: 1; }

    .metadata-line { font-size: 13px; margin-top: 8px; padding: 6px 0; color: #333; display: flex; flex-wrap: wrap; gap: 20px; }
    .metadata-line strong { font-weight: 600; margin-right: 4px; }

    .activity-summary { display: flex; align-items: center; justify-content: space-between; margin: 8px 0 10px 0; }
    .activity-toggle { display: inline-flex; align-items: center; gap: 6px; font-size: 14px; color: #0066cc; cursor: pointer; user-select: none; }
    .activity-toggle:hover { text-decoration: underline; }
    .arrow { display: inline-block; transition: transform 0.3s ease; }
    .collapsed .arrow { transform: rotate(-90deg); }

    .status-circles { display: flex; gap: 4px; }
    .circle { width: 12px; height: 12px; border-radius: 50%; cursor: pointer; transition: transform 0.2s ease; }
    .circle:hover { animation: pulse 1.5s infinite; }
    .circle.done { background-color: #28a745; }
    .circle.working { background-color: #ffc107; }
    .circle.stuck { background-color: #dc3545; }
    .circle.pending { background-color: #6c757d; }

    .sublist { margin-top: 10px; list-style: none; padding-left: 0; }
    .subitem { padding: 14px 16px; border: 1px solid #d5dce1; border-radius: 10px; margin-bottom: 10px; font-size: 14px; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04); background: #f8fafc; display: flex; align-items: center; gap: 10px; }
    .status-indicator { width: 16px; height: 16px; border-radius: 50%; flex-shrink: 0; cursor: pointer; }
    .status-indicator:hover { animation: pulse 1.5s infinite; }

    @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0,0,0,0.2); } 50% { transform: scale(1.2); box-shadow: 0 0 6px rgba(0, 0, 0, 0.2); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0,0,0,0.2); } }

    .subitem-content { flex: 1; }
    .pill { display: inline-block; font-size: 13px; margin-top: 6px; margin-right: 12px; padding: 0; background-color: transparent; color: inherit; }
    .pill strong { font-weight: 600; margin-right: 4px; }
    .overdue { color: #ffffff; font-weight: 600; background: #dc3545; border-radius: 4px; padding: 1px 4px; cursor: pointer; }
    .missing-data { color: #ffffff; font-weight: 600; background: #ffc107; border-radius: 4px; padding: 1px 4px; cursor: pointer; }

    .status-done { background-color: #28a745; }
    .status-working { background-color: #ffc107; }
    .status-pending { background-color: #6c757d; }
    .status-stuck { background-color: #dc3545; }
    .status-default { background-color: #d5dce1; }

    .email-taskforce-btn { padding: 6px 12px; font-size: 12px; background: #0066cc; color: #fff; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap; }
    .email-taskforce-btn:hover { background: #004c99; }

    .hidden { display: none; }

    /* Overlay + tooltip */
    #loadingOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 20px; font-weight: bold; text-align: center; padding: 20px; }
    .pulse-word { animation: pulseImpact 1.5s infinite; color: #28a745; }
    @keyframes pulseImpact { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.3); opacity: 0.6; } 100% { transform: scale(1); opacity: 1; } }
    .tooltip { position: fixed; background: rgba(0, 0, 0, 0.8); color: #fff; padding: 6px 10px; font-size: 12px; border-radius: 4px; pointer-events: none; opacity: 0; transition: opacity 0.15s ease; z-index: 1000; }
  </style>

  <!-- PDF.js (for live PDF text search if CORS allows) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.min.js"></script>
</head>
<body>
  <h1>KPIs, Milestones, and associated Activities</h1>

  <!-- Search UI -->
  <div class="search-row">
    <input id="searchInput" class="search-input" type="search" placeholder="Search pillars, KPIs, milestones, activities, and the Strategy PDF…" />
    <button class="search-btn" id="searchBtn">Search</button>
    <button class="clear-btn" id="clearBtn">Clear</button>
  </div>
  <div class="search-hint">Tip: try terms like <em>CRISPR</em>, <em>genomics</em>, <em>clinical trial</em>, etc.</div>

  <!-- Strategy PDF hits -->
  <div id="strategyResults" class="strategy-results hidden">
    <h3>Strategy matches</h3>
    <div id="strategyHits"></div>
  </div>

  <div class="refresh-container-top">
    <button class="refresh-btn" onclick="expandAll()">Expand All</button>
    <button class="refresh-btn" onclick="collapseAll()">Collapse All</button>
    <button class="refresh-btn" onclick="loadData()">Refresh Data</button>
  </div>

  <!-- CORE DATA ONLY -->
  <div id="milestoneSections"></div>

  <div class="refresh-container">
    <button class="refresh-btn" onclick="expandAll()">Expand All</button>
    <button class="refresh-btn" onclick="collapseAll()">Collapse All</button>
    <button class="refresh-btn" onclick="loadData()">Refresh Data</button>
  </div>

  <div id="loadingOverlay">Gathering <span class="pulse-word">IMPACT</span> data from ONJCRI...</div>
  <div class="tooltip" id="tooltip"></div>

  <script>
    // === Config ===
    const STRATEGY_PDF_URL =
      "https://onjcri.sharepoint.com/sites/Intranet-DocumentsHub/PublishedDocuments/ONJCRI%20Impact%20Strategy_Abridged.pdf";
    // If CORS prevents reading the PDF, create /strategy-index.json in your public folder (same origin)
    // Format: [{ "page": 14, "section": "Sustainability", "text": "… sentence that contains CRISPR …" }, ...]
    const STRATEGY_INDEX_URL = "/strategy-index.json";

    const tooltip = document.getElementById('tooltip');
    const overlay = document.getElementById('loadingOverlay');
    let originalData = null;
    let currentQuery = "";

    function showTooltip(text, x, y) { if(!text) return; tooltip.textContent = text; tooltip.style.left = x + 10 + 'px'; tooltip.style.top = y + 10 + 'px'; tooltip.style.opacity = 1; }
    function hideTooltip() { tooltip.style.opacity = 0; }

    function isOverdue(endDateStr) {
      if (!endDateStr) return false;
      const parts = endDateStr.split('/');
      if (parts.length !== 3) return false;
      const [day, month, year] = parts.map(Number);
      const endDate = new Date(year, month - 1, day);
      return endDate < new Date();
    }

    async function loadData() {
      overlay.style.display = 'flex';
      try {
        const res = await fetch('/api/milestones');
        const data = await res.json();
        if (!data.success) throw new Error(data.error || 'Unknown error');
        originalData = data;
        renderSections(originalData);
      } catch (err) {
        console.error(err);
      } finally {
        overlay.style.display = 'none';
      }
    }

    function expandAll() {
      document.querySelectorAll('#milestoneSections section > div:nth-of-type(3)').forEach(wrapper => wrapper.classList.remove('hidden'));
      document.querySelectorAll('.sublist').forEach(list => list.classList.remove('hidden'));
      document.querySelectorAll('.activity-toggle').forEach(toggle => toggle.classList.remove('collapsed'));
      document.querySelectorAll('.section-heading-container').forEach(header => header.classList.remove('collapsed'));
    }
    function collapseAll() {
      document.querySelectorAll('#milestoneSections section > div:nth-of-type(3)').forEach(wrapper => wrapper.classList.add('hidden'));
      document.querySelectorAll('.sublist').forEach(list => list.classList.add('hidden'));
      document.querySelectorAll('.activity-toggle').forEach(toggle => toggle.classList.add('collapsed'));
      document.querySelectorAll('.section-heading-container').forEach(header => header.classList.add('collapsed'));
    }

    function milestoneAllActivitiesDone(milestoneName) {
      const milestone = originalData.items.find(i => i.name === milestoneName);
      if (!milestone) return false;
      return milestone.subitems.length > 0 && milestone.subitems.every(sub => (sub.status || '').toLowerCase() === 'done');
    }

    function getSections() {
      return {
        "Pillar: Advancing Scientific Research": { milestones: ["M1","M2","M3","M4","M5","M6","M7","M8","M9","M10.1","M10.2","M11"], description: "<strong>KPI:</strong> By 2029, enhance ONJCRI’s scientific research capacity by implementing advanced technologies, expanding research outputs, and developing innovative models to identify therapeutic targets and improve cancer outcomes." },
        "Pillar: Research Translation and Commercialisation": { milestones: ["M12","M13","M14","M15","M16","M17","M18","M19"], description: "<strong>KPI:</strong> By 2029, advance research translation by developing multiple therapeutic candidates, progressing clinical trials, and securing commercial partnerships to ensure ONJCRI innovations reach patients." },
        "Pillar: Operational Excellence": { milestones: ["M25","M26","M27","M28","M29","M30","M31","M32","M33","M34","M36","M37","M38","M39","M40","M42","M43"], description: "<strong>KPI:</strong> By 2029, optimise ONJCRI’s operational performance through enhanced governance, financial planning, branding, and stakeholder engagement to ensure long-term sustainability and global recognition." },
        "Pillar: Sustainability": { milestones: ["M22","M23","M24","M35","M44"], description: "<strong>KPI:</strong> By 2029, embed sustainability principles across ONJCRI’s research and operations by reducing carbon emissions, increasing biobank diversity, and achieving full participation in equity initiatives." },
        "Pillar: Ethical and Regulatory Conduct": { milestones: ["M20","M21","M41"], description: "<strong>KPI:</strong> By 2029, uphold the highest standards of ethics, governance, and regulatory compliance through continuous monitoring of research protocols, data security, and risk management frameworks." }
      };
    }

    function getMilestoneEmail(milestone) {
      const emails = {
        "M1":"onjcri_pulse_1987359246_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M2":"onjcri_pulse_1987359247_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M9":"onjcri_pulse_1987359248_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M10.1":"onjcri_pulse_1987359249_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M10.2":"onjcri_pulse_1987368440_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M7":"onjcri_pulse_1987359250_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M8":"onjcri_pulse_1987359251_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M3":"onjcri_pulse_1987359252_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M4":"onjcri_pulse_1987359253_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M5":"onjcri_pulse_1987359256_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M6":"onjcri_pulse_1987359257_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M11":"onjcri_pulse_1987359259_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M17":"onjcri_pulse_1987380037_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M18":"onjcri_pulse_1987380044_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M19":"onjcri_pulse_1987380051_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M14":"onjcri_pulse_1987380060_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M15":"onjcri_pulse_1987380065_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M16":"onjcri_pulse_1987380069_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M12":"onjcri_pulse_1987380073_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M13":"onjcri_pulse_1987380079_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M26":"onjcri_pulse_1987380673_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M36":"onjcri_pulse_1987380676_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M38":"onjcri_pulse_1987380678_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M39":"onjcri_pulse_1987380682_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M40":"onjcri_pulse_1987380684_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M42":"onjcri_pulse_1987380687_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M25":"onjcri_pulse_1987380689_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M27":"onjcri_pulse_1987380691_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M28":"onjcri_pulse_1987380694_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M30":"onjcri_pulse_1987380698_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M31":"onjcri_pulse_1987380701_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M32":"onjcri_pulse_1987380703_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M33":"onjcri_pulse_1987380705_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M29":"onjcri_pulse_1987380709_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M34":"onjcri_pulse_1987380710_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M43":"onjcri_pulse_1987380714_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M37":"onjcri_pulse_1987380719_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M44":"onjcri_pulse_1987381563_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M23":"onjcri_pulse_1987381569_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M35":"onjcri_pulse_1987381566_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M24":"onjcri_pulse_1987381579_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M22":"onjcri_pulse_1987381574_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M41":"onjcri_pulse_1987381253_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M20":"onjcri_pulse_1987381256_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M21":"onjcri_pulse_1987381262_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com"
      };
      return emails[milestone] || "default@onjcri.org";
    }

    // ===== SEARCH HELPERS =====
    function escapeRegExp(string) { return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
    function normalize(s) { return (s || '').toString(); }
    function includesInsensitive(hay, needle) { return normalize(hay).toLowerCase().includes(normalize(needle).toLowerCase()); }

    function highlight(text) {
      if (!currentQuery || !text) return text || '';
      const rx = new RegExp(`(${escapeRegExp(currentQuery)})`, 'ig');
      return normalize(text).replace(rx, '<mark>$1</mark>');
    }

    function subitemMatchesQuery(sub, q) {
      const s = (sub.status || '').toLowerCase();
      return (
        includesInsensitive(sub.name, q) ||
        includesInsensitive(sub.sponsor, q) ||
        includesInsensitive(sub.lead, q) ||
        includesInsensitive(sub.timeline, q) ||
        includesInsensitive(s, q)
      );
    }

    function milestoneHeaderMatchesQuery(item, q) {
      return (
        includesInsensitive(item.name, q) ||
        includesInsensitive(item.description, q) ||
        includesInsensitive(item.portfolio, q) ||
        includesInsensitive(item.date, q)
      );
    }

    function itemMatchesQuery(item, q) {
      if (milestoneHeaderMatchesQuery(item, q)) return true;
      return (item.subitems || []).some(sub => subitemMatchesQuery(sub, q));
    }

    // ===== RENDER SECTIONS (with in-place filtering + highlight) =====
    function renderSections(filteredData) {
      const container = document.getElementById('milestoneSections');
      container.innerHTML = '';

      const sections = getSections();

      for (const [sectionTitle, { milestones, description }] of Object.entries(sections)) {
        const itemsForSectionAll = filteredData.items.filter(i => milestones.includes(i.name));
        const itemsForSection = currentQuery
          ? itemsForSectionAll.filter(i => itemMatchesQuery(i, currentQuery))
          : itemsForSectionAll;

        if (itemsForSection.length === 0) continue;

        const section = document.createElement('section');

        // Header (collapsible)
        const headerContainer = document.createElement('div'); 
        headerContainer.className = 'section-heading-container collapsed';
        const arrow = document.createElement('span'); 
        arrow.className = 'section-arrow'; 
        arrow.textContent = '▼';
        const heading = document.createElement('h2'); 
        heading.className = 'section-heading'; 
        heading.textContent = sectionTitle;
        headerContainer.appendChild(arrow); 
        headerContainer.appendChild(heading); 
        section.appendChild(headerContainer);

        // KPI description
        const desc = document.createElement('p'); 
        desc.className = 'section-description'; 
        desc.innerHTML = description; 
        section.appendChild(desc);

        // Progress bar (based on activities across milestones in this section)
        const allSubitems = itemsForSection.flatMap(i => i.subitems);
        const counts = { done: 0, working: 0, stuck: 0, pending: 0 };
        allSubitems.forEach(sub => {
          const s = (sub.status || '').toLowerCase();
          if (s === 'done') counts.done++;
          else if (s === 'working on it') counts.working++;
          else if (s === 'stuck') counts.stuck++;
          else counts.pending++;
        });
        const total = allSubitems.length || 1;
        const donePct = (counts.done / total) * 100, 
              workingPct = (counts.working / total) * 100, 
              stuckPct = (counts.stuck / total) * 100, 
              pendingPct = (counts.pending / total) * 100;

        const progressContainer = document.createElement('div');
        progressContainer.className = 'kpi-progress-container';
        progressContainer.innerHTML = `
          <div class="progress-bar">
            <div class="bar-segment bar-done" style="width:${donePct}%" data-status="Done: ${counts.done} Activities"></div>
            <div class="bar-segment bar-working" style="width:${workingPct}%" data-status="Working on It: ${counts.working} Activities"></div>
            <div class="bar-segment bar-stuck" style="width:${stuckPct}%" data-status="Stuck: ${counts.stuck} Activities"></div>
            <div class="bar-segment bar-pending" style="width:${pendingPct}%" data-status="Pending: ${counts.pending} Activities"></div>
          </div>`;
        section.appendChild(progressContainer);

        // Milestone list (collapsed by default)
        const listWrapper = document.createElement('div'); 
        listWrapper.classList.add('hidden');
        const list = document.createElement('ul'); 
        list.style.listStyle = 'none'; 
        list.style.paddingLeft = '0';

        itemsForSection.forEach((item, index) => {
          // If searching: filter subitems too
          const subitemsFiltered = currentQuery
            ? item.subitems.filter(s => subitemMatchesQuery(s, currentQuery))
            : item.subitems;

          // If searching and a milestone has no matching subitems + no header match, skip showing its card
          if (currentQuery && !milestoneHeaderMatchesQuery(item, currentQuery) && subitemsFiltered.length === 0) {
            return;
          }

          const li = document.createElement('li');
          li.className = 'milestone-container';
          li.id = item.name;

          const allDone = milestoneAllActivitiesDone(item.name);
          const badgeClass = allDone ? 'milestone-badge done' : 'milestone-badge';
          const sublistId = `${sectionTitle.replace(/\s+/g, '-')}-sublist-${index}`;
          const toggleId = `${sectionTitle.replace(/\s+/g, '-')}-toggle-${index}`;
          const completionTargetOverdue = item.date && isOverdue(item.date);

          // Email link
          const email = getMilestoneEmail(item.name);
          const emailBody = encodeURIComponent(
            `Dear ${item.name} Taskforce,\n\n` +
            `I am writing regarding the progress of a strategic Milestone to which you have been assigned: ${item.description || "No description provided"}\n\n` +
            `[Please add your specific question here].\n\nThank you,`
          );
          const mailtoLink = `mailto:${email}?subject=${encodeURIComponent("Enquiry regarding " + item.name)}&body=${emailBody}`;

          const subitemsHtml = subitemsFiltered.map(sub => {
            const s = (sub.status || '').toLowerCase();
            let statusClass = 'status-default', statusText = 'Unknown';
            if (s === 'done') { statusClass = 'status-done'; statusText = 'Done'; }
            else if (s === 'working on it') { statusClass = 'status-working'; statusText = 'Working on It'; }
            else if (s === 'pending') { statusClass = 'status-pending'; statusText = 'Pending'; }
            else if (s === 'stuck') { statusClass = 'status-stuck'; statusText = 'Stuck'; }

            const missingSponsor = !sub.sponsor;
            const missingLead = !sub.lead;
            const missingTimeline = !sub.timeline;
            const overdueClass = sub.timeline && isOverdue(sub.timeline.split('–').pop().trim()) && s !== 'done'
              ? 'overdue'
              : (missingTimeline ? 'missing-data' : '');

            return `<li class="subitem">
                      <div class="status-indicator ${statusClass}" data-status="${statusText}"></div>
                      <div class="subitem-content">
                        <span class="pill"><strong>Activity:</strong> ${highlight(sub.name)}</span><br/>
                        <span class="pill"><strong>Executive Sponsor(s):</strong> <span class="${missingSponsor ? 'missing-data' : ''}">${highlight(sub.sponsor || 'Not Assigned')}</span></span>
                        <span class="pill"><strong>Operational Lead(s):</strong> <span class="${missingLead ? 'missing-data' : ''}">${highlight(sub.lead || 'Not Assigned')}</span></span>
                        <span class="pill"><strong>Timeline:</strong> <span class="${overdueClass}">${highlight(sub.timeline || 'Missing')}</span></span>
                      </div>
                    </li>`;
          }).join('');

          const activityCountLabel = currentQuery ? subitemsFiltered.length : item.subitems.length;

          li.innerHTML = `
            <div class="${badgeClass}">${item.name}</div>
            <div class="milestone-content">
              <div class="milestone-header">
                <span class="description">${highlight(item.description || 'No description provided.')}</span>
                <button class="email-taskforce-btn" onclick="window.location.href='${mailtoLink}'" data-status="Email Taskforce for ${item.name}">Email Taskforce</button>
              </div>
              ${item.portfolio || item.date ? `<div class="metadata-line">
                ${item.portfolio ? `<span><strong>Executive Portfolio(s):</strong> ${highlight(item.portfolio)}</span>` : ''}
                ${item.date ? `<span><strong>Completion Target:</strong> <span class="${completionTargetOverdue ? 'overdue' : ''}">${highlight(item.date)}</span></span>` : ''}
              </div>` : ''}
              <div class="activity-summary">
                <div class="activity-toggle" id="${toggleId}">
                  <span class="arrow">▼</span>${activityCountLabel} Activities
                </div>
                <div class="status-circles">
                  ${(currentQuery ? subitemsFiltered : item.subitems).map(sub => {
                    const s = (sub.status || '').toLowerCase();
                    let cls = 'pending', label = 'Pending';
                    if (s === 'done') { cls = 'done'; label = 'Done'; }
                    else if (s === 'working on it') { cls = 'working'; label = 'Working on It'; }
                    else if (s === 'stuck') { cls = 'stuck'; label = 'Stuck'; }
                    return `<div class="circle ${cls}" data-status="${label}"></div>`;
                  }).join('')}
                </div>
              </div>
              <ul id="${sublistId}" class="hidden sublist">${subitemsHtml}</ul>
            </div>`;

          list.appendChild(li);
          li.querySelector('.activity-toggle').onclick = () => toggleSublist(sublistId, toggleId);
        });

        listWrapper.appendChild(list);
        section.appendChild(listWrapper);

        // Section collapse toggle
        headerContainer.onclick = () => {
          const isHidden = listWrapper.classList.toggle('hidden');
          headerContainer.classList.toggle('collapsed', isHidden);
        };

        container.appendChild(section);
      }

      // Tooltips
      document.querySelectorAll('.status-indicator, .status-circles .circle, .bar-segment, .email-taskforce-btn').forEach(el => {
        el.addEventListener('mousemove', e => showTooltip(el.dataset.status || '', e.clientX, e.clientY));
        el.addEventListener('mouseleave', hideTooltip);
      });
    }

    function toggleSublist(sublistId, toggleId) {
      const sublist = document.getElementById(sublistId);
      const toggle = document.getElementById(toggleId);
      if (!sublist || !toggle) return;
      const isHidden = sublist.classList.toggle('hidden');
      toggle.classList.toggle('collapsed', isHidden);
    }

    // ===== Strategy PDF Search (PDF.js first, then JSON fallback) =====
    async function searchStrategy(query) {
      const panel = document.getElementById('strategyResults');
      const hitsDiv = document.getElementById('strategyHits');
      hitsDiv.innerHTML = '';
      panel.classList.add('hidden');
      if (!query || query.trim() === '') return;

      // Try PDF.js (may fail due to CORS)
      try {
        const pdf = await pdfjsLib.getDocument({ url: STRATEGY_PDF_URL }).promise;
        const numPages = pdf.numPages;
        const results = [];
        const qLower = query.toLowerCase();

        for (let p = 1; p <= numPages; p++) {
          const page = await pdf.getPage(p);
          const txt = await page.getTextContent();
          const pageText = txt.items.map(it => it.str).join(' ');
          const idx = pageText.toLowerCase().indexOf(qLower);
          if (idx !== -1) {
            const snippet = snippetAround(pageText, idx, query.length);
            results.push({ page: p, section: null, text: snippet });
            if (results.length >= 12) break;
          }
        }

        if (results.length > 0) {
          renderStrategyHits(results, query);
        } else {
          // If no hits via PDF.js, still show "no results"
          panel.classList.remove('hidden');
          hitsDiv.innerHTML = `<div class="strategy-hit"><span class="hit-snippet">No mentions found in the Strategy PDF.</span></div>`;
        }
        return;
      } catch (e) {
        // Fall through to JSON index
        // console.warn('PDF.js failed or blocked; using JSON index fallback.', e);
      }

      // JSON fallback
      try {
        const res = await fetch(STRATEGY_INDEX_URL, { cache: 'no-store' });
        if (!res.ok) throw new Error('No strategy index available');
        const index = await res.json(); // [{page, section, text}]
        const qLower = query.toLowerCase();
        const results = index.filter(row =>
          (row.text && row.text.toLowerCase().includes(qLower)) ||
          (row.section && row.section.toLowerCase().includes(qLower))
        ).slice(0, 20);
        if (results.length > 0) {
          renderStrategyHits(results, query);
        } else {
          const panel = document.getElementById('strategyResults');
          const hitsDiv = document.getElementById('strategyHits');
          panel.classList.remove('hidden');
          hitsDiv.innerHTML = `<div class="strategy-hit"><span class="hit-snippet">No mentions found in the Strategy.</span></div>`;
        }
      } catch (e2) {
        // No PDF, no JSON — hide panel silently
        // console.error('Strategy search unavailable:', e2);
      }
    }

    function snippetAround(text, startIdx, len, context = 80) {
      const begin = Math.max(0, startIdx - context);
      const end = Math.min(text.length, startIdx + len + context);
      const prefix = begin > 0 ? '…' : '';
      const suffix = end < text.length ? '…' : '';
      const before = text.slice(begin, startIdx);
      const match = text.slice(startIdx, startIdx + len);
      const after = text.slice(startIdx + len, end);
      return `${prefix}${before}<mark>${match}</mark>${after}${suffix}`;
    }

    function renderStrategyHits(results, query) {
      const panel = document.getElementById('strategyResults');
      const hitsDiv = document.getElementById('strategyHits');
      hitsDiv.innerHTML = '';
      panel.classList.remove('hidden');

      results.forEach(r => {
        const page = r.page || '?';
        const section = r.section ? ` • ${r.section}` : '';
        const url = `${STRATEGY_PDF_URL}#page=${page}`;
        const snippet = r.text ? r.text : '';
        const item = document.createElement('div');
        item.className = 'strategy-hit';
        item.innerHTML = `
          <div><span class="hit-title">Impact Strategy</span>
               <span class="hit-meta">Page ${page}${section}</span></div>
          <div class="hit-snippet">${snippet}</div>
          <div style="margin-top:6px;">
            <a href="${url}" target="_blank" rel="noopener">Open on page ${page}</a>
          </div>
        `;
        hitsDiv.appendChild(item);
      });
    }

    // ===== Search UI wiring =====
    function doSearch() {
      const q = document.getElementById('searchInput').value.trim();
      currentQuery = q;
      renderSections(originalData);
      searchStrategy(q);
      // Expand sections automatically when searching, collapse when cleared
      if (q) expandAll();
    }

    function clearSearch() {
      currentQuery = '';
      document.getElementById('searchInput').value = '';
      renderSections(originalData);
      document.getElementById('strategyHits').innerHTML = '';
      document.getElementById('strategyResults').classList.add('hidden');
      collapseAll();
    }

    document.getElementById('searchBtn').addEventListener('click', doSearch);
    document.getElementById('clearBtn').addEventListener('click', clearSearch);
    document.getElementById('searchInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') doSearch();
    });

    // Kick things off
    loadData();
  </script>
</body>
</html>
