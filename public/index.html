<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>KPIs, Milestones, and associated Activities</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --brand:#003e6b;
      --blue:#0066cc;
      --blue-dark:#004c99;
      --bg:#f7f9fb;
      --ink:#2b2b2b;
      --muted:#444;
      --line:#d9e1ea;
      --card:#ffffff;
      --chip:#f0f4f8;
      --shadow:0 1px 3px rgba(0,0,0,0.05);
    }
    body{font-family:'Segoe UI', Tahoma, sans-serif;background:var(--bg);color:var(--ink);margin:0;padding:40px;}
    h1{font-size:32px;font-weight:700;margin:0 0 16px;color:#103c60;border-bottom:2px solid var(--line);padding-bottom:10px;}

    /* Search bar */
    .search-row{display:flex;gap:8px;align-items:center;margin:12px 0 18px}
    .search-input{flex:1; height:38px; border:2px solid #c8d6e5; border-radius:6px; padding:0 12px; font-size:14px; outline:none;}
    .search-input:focus{border-color:var(--blue)}
    .btn{padding:10px 16px;background:var(--blue);color:#fff;border:none;border-radius:6px;font-size:14px;cursor:pointer;box-shadow:0 2px 4px rgba(0,0,0,0.15);transition:background .15s,transform .05s}
    .btn.secondary{background:#6b7785}
    .btn:hover{background:var(--blue-dark)}
    .btn.secondary:hover{background:#4f5964}
    .btn:active{transform:scale(0.98)}
    .search-tip{font-size:12px;color:#777;margin-top:4px}

    .refresh-container-top,.refresh-container{text-align:center;margin-top:16px}
    .refresh-btn{padding:10px 20px;background-color:var(--blue);color:#fff;border:none;border-radius:6px;font-size:14px;cursor:pointer;box-shadow:0 2px 4px rgba(0,0,0,0.2);transition:background .2s,transform .1s;margin:0 5px;}
    .refresh-btn:hover{background-color:var(--blue-dark)}
    .refresh-btn:active{transform:scale(0.98)}

    /* Section headers (KPI pillars) */
    .section-heading-container{display:flex;align-items:center;gap:8px;cursor:pointer;margin-top:28px;padding-left:10px;border-left:5px solid var(--brand);}
    h2.section-heading{font-size:20px;margin:0;color:var(--brand);}
    .section-arrow{font-size:16px;transition:transform .3s ease;color:var(--brand);}
    .collapsed .section-arrow{transform:rotate(-90deg);}
    .section-description{font-size:14px;color:var(--muted);margin:8px 0 12px 6px;font-style:italic;max-width:100%;}

    /* KPI progress bars */
    .kpi-progress-container{margin:10px 0 20px 6px;position:relative;}
    .progress-bar{display:flex;height:14px;border-radius:7px;overflow:hidden;background:#e0e0e0;width:100%;}
    .bar-segment{height:100%;position:relative;cursor:pointer;transition:transform .2s ease;}
    .bar-done{background:#28a745;}
    .bar-working{background:#ffc107;}
    .bar-stuck{background:#dc3545;}
    .bar-pending{background:#6c757d;}

    /* Milestone cards */
    li.milestone-container{display:flex;position:relative;background:var(--card);border:1px solid #e0e4e8;border-radius:10px;padding:16px 18px;margin-bottom:16px;box-shadow:var(--shadow);}
    .milestone-badge{flex-shrink:0;width:50px;display:flex;align-items:center;justify-content:center;font-weight:bold;color:var(--brand);background:var(--chip);border-right:2px solid #d1d9e0;border-radius:8px 0 0 8px;box-shadow:inset -2px 0 5px rgba(0,0,0,.05);writing-mode:vertical-rl;text-orientation:mixed;transform:rotate(180deg);font-size:14px;letter-spacing:1px;transition:background .3s,color .3s;}
    .milestone-badge.done{background:#28a745!important;color:#fff!important;}

    .milestone-content{flex:1;padding-left:14px;display:flex;flex-direction:column;}
    .milestone-header{display:flex;flex-direction:row;align-items:flex-start;justify-content:space-between;margin-bottom:6px;width:100%;gap:10px;}
    .description{font-style:italic;font-size:14px;color:#555;white-space:normal;flex:1;}

    .metadata-line{font-size:13px;margin-top:8px;padding:6px 0;color:#333;display:flex;flex-wrap:wrap;gap:20px;}
    .metadata-line strong{font-weight:600;margin-right:4px;}

    .activity-summary{display:flex;align-items:center;justify-content:space-between;margin:8px 0 10px 0;}
    .activity-toggle{display:inline-flex;align-items:center;gap:6px;font-size:14px;color:var(--blue);cursor:pointer;user-select:none;}
    .activity-toggle:hover{text-decoration:underline;}
    .arrow{display:inline-block;transition:transform .3s ease;}
    .collapsed .arrow{transform:rotate(-90deg);}

    .status-circles{display:flex;gap:4px;}
    .circle{width:12px;height:12px;border-radius:50%;cursor:pointer;transition:transform .2s ease;}
    .circle:hover{animation:pulse 1.5s infinite;}
    .circle.done{background:#28a745;}
    .circle.working{background:#ffc107;}
    .circle.stuck{background:#dc3545;}
    .circle.pending{background:#6c757d;}

    .sublist{margin-top:10px;list-style:none;padding-left:0;}
    .subitem{padding:14px 16px;border:1px solid #d5dce1;border-radius:10px;margin-bottom:10px;font-size:14px;box-shadow:0 1px 2px rgba(0,0,0,.04);background:#f8fafc;display:flex;align-items:center;gap:10px;}
    .status-indicator{width:16px;height:16px;border-radius:50%;flex-shrink:0;cursor:pointer;}
    .status-indicator:hover{animation:pulse 1.5s infinite;}

    @keyframes pulse{0%{transform:scale(1);box-shadow:0 0 0 0 rgba(0,0,0,.2);}50%{transform:scale(1.2);box-shadow:0 0 6px rgba(0,0,0,.2);}100%{transform:scale(1);box-shadow:0 0 0 0 rgba(0,0,0,.2);}}

    .subitem-content{flex:1;}
    .pill{display:inline-block;font-size:13px;margin-top:6px;margin-right:12px;padding:0;background:transparent;color:inherit;}
    .pill strong{font-weight:600;margin-right:4px;}
    .overdue{color:#fff;font-weight:600;background:#dc3545;border-radius:4px;padding:1px 4px;cursor:pointer;}
    .missing-data{color:#fff;font-weight:600;background:#ffc107;border-radius:4px;padding:1px 4px;cursor:pointer;}

    .status-done{background:#28a745;}
    .status-working{background:#ffc107;}
    .status-pending{background:#6c757d;}
    .status-stuck{background:#dc3545;}
    .status-default{background:#d5dce1;}

    .email-taskforce-btn{padding:6px 12px;font-size:12px;background:var(--blue);color:#fff;border:none;border-radius:4px;cursor:pointer;white-space:nowrap;}
    .email-taskforce-btn:hover{background:var(--blue-dark);}

    .hidden{display:none;}

    /* Overlay + tooltip */
    #loadingOverlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:2000;display:flex;align-items:center;justify-content:center;color:#fff;font-size:20px;font-weight:bold;text-align:center;padding:20px;}
    .pulse-word{animation:pulseImpact 1.5s infinite;color:#28a745;}
    @keyframes pulseImpact{0%{transform:scale(1);opacity:1;}50%{transform:scale(1.3);opacity:.6;}100%{transform:scale(1);opacity:1;}}
    .tooltip{position:fixed;background:rgba(0,0,0,.8);color:#fff;padding:6px 10px;font-size:12px;border-radius:4px;pointer-events:none;opacity:0;transition:opacity .15s ease;z-index:1000;}

    /* Strategy matches box */
    .strategy-box{background:#eef5ff;border:1px solid #cfe0ff;border-radius:10px;padding:12px 14px;margin:8px 0 14px;display:none}
    .strategy-box h3{margin:0 0 8px;font-size:16px;color:#123a63}
    .strategy-hit{background:#fff;border:1px solid #e2e9f7;border-radius:8px;padding:10px 12px;margin:8px 0}
    .strategy-hit small{color:#50627a}
    .hit-snippet mark{background:#fff3cd;padding:0 2px;border-radius:2px}

    /* Highlight inside data */
    mark{background:#fff3cd;padding:0 2px;border-radius:2px}
  </style>
</head>
<body>
  <h1>KPIs, Milestones, and associated Activities</h1>

  <!-- Search -->
  <div class="search-row">
    <input id="searchInput" class="search-input" type="text" placeholder="Search pillars, KPIs, milestones, activitiesâ€¦ (e.g., CRISPR, genomics, clinical trial)" />
    <button class="btn" id="btnSearch">Search</button>
    <button class="btn secondary" id="btnClear">Clear</button>
  </div>
  <div class="search-tip">Tip: try terms like <em>CRISPR</em>, <em>genomics</em>, <em>clinical trial</em>, etc.</div>

  <!-- Strategy PDF matches -->
  <div id="strategyBox" class="strategy-box">
    <h3>Strategy matches</h3>
    <div id="strategyHits"></div>
  </div>

  <div class="refresh-container-top">
    <button class="refresh-btn" onclick="expandAll()">Expand All</button>
    <button class="refresh-btn" onclick="collapseAll()">Collapse All</button>
    <button class="refresh-btn" onclick="loadData()">Refresh Data</button>
  </div>

  <!-- CORE DATA ONLY -->
  <div id="milestoneSections"></div>

  <div class="refresh-container">
    <button class="refresh-btn" onclick="expandAll()">Expand All</button>
    <button class="refresh-btn" onclick="collapseAll()">Collapse All</button>
    <button class="refresh-btn" onclick="loadData()">Refresh Data</button>
  </div>

  <div id="loadingOverlay">Gathering <span class="pulse-word">IMPACT</span> data from ONJCRI...</div>
  <div class="tooltip" id="tooltip"></div>

  <script>
    /*********************
     * Config
     *********************/
    // Public Strategy PDF (WordPress)
    const STRATEGY_PDF_URL = "https://www.onjcri.org.au/wp-content/uploads/2025/06/ONJCRI_Impact-Strategy_16-page_WEB.pdf";
    const ENABLE_STRATEGY_PDF_SEARCH = true;

    /*********************
     * Globals
     *********************/
    const tooltip = document.getElementById('tooltip');
    const overlay = document.getElementById('loadingOverlay');
    let originalData = null;
    let currentQuery = "";
    // PDF cache/index
    let pdfDocPromise = null;
    let pdfPageText = []; // [{page:1, text:"..."}, ...]
    let pdfIndexed = false;

    function showTooltip(text, x, y){ tooltip.textContent = text; tooltip.style.left = (x+10)+'px'; tooltip.style.top = (y+10)+'px'; tooltip.style.opacity = 1; }
    function hideTooltip(){ tooltip.style.opacity = 0; }

    function isOverdue(endDateStr){
      if(!endDateStr) return false;
      const parts = endDateStr.split('/');
      if(parts.length !== 3) return false;
      const [day, month, year] = parts.map(Number);
      const endDate = new Date(year, month-1, day);
      return endDate < new Date();
    }

    async function loadData(){
      overlay.style.display = 'flex';
      try{
        const res = await fetch('/api/milestones');
        const data = await res.json();
        if(!data.success) throw new Error(data.error || 'Unknown error');
        originalData = data;
        renderSections(originalData, currentQuery);
      }catch(err){
        console.error(err);
      }finally{
        overlay.style.display = 'none';
      }
    }

    function expandAll(){
      document.querySelectorAll('#milestoneSections section > div:nth-of-type(3)').forEach(w => w.classList.remove('hidden'));
      document.querySelectorAll('.sublist').forEach(l => l.classList.remove('hidden'));
      document.querySelectorAll('.activity-toggle').forEach(t => t.classList.remove('collapsed'));
      document.querySelectorAll('.section-heading-container').forEach(h => h.classList.remove('collapsed'));
    }
    function collapseAll(){
      document.querySelectorAll('#milestoneSections section > div:nth-of-type(3)').forEach(w => w.classList.add('hidden'));
      document.querySelectorAll('.sublist').forEach(l => l.classList.add('hidden'));
      document.querySelectorAll('.activity-toggle').forEach(t => t.classList.add('collapsed'));
      document.querySelectorAll('.section-heading-container').forEach(h => h.classList.add('collapsed'));
    }

    function milestoneAllActivitiesDone(milestoneName){
      const milestone = originalData?.items?.find(i => i.name === milestoneName);
      if(!milestone) return false;
      return milestone.subitems.length > 0 && milestone.subitems.every(sub => (sub.status || '').toLowerCase() === 'done');
    }

    function getSections(){
      return {
        "Pillar: Advancing Scientific Research": { milestones: ["M1","M2","M3","M4","M5","M6","M7","M8","M9","M10.1","M10.2","M11"], description: "<strong>KPI:</strong> By 2029, enhance ONJCRIâ€™s scientific research capacity by implementing advanced technologies, expanding research outputs, and developing innovative models to identify therapeutic targets and improve cancer outcomes." },
        "Pillar: Research Translation and Commercialisation": { milestones: ["M12","M13","M14","M15","M16","M17","M18","M19"], description: "<strong>KPI:</strong> By 2029, advance research translation by developing multiple therapeutic candidates, progressing clinical trials, and securing commercial partnerships to ensure ONJCRI innovations reach patients." },
        "Pillar: Operational Excellence": { milestones: ["M25","M26","M27","M28","M29","M30","M31","M32","M33","M34","M36","M37","M38","M39","M40","M42","M43"], description: "<strong>KPI:</strong> By 2029, optimise ONJCRIâ€™s operational performance through enhanced governance, financial planning, branding, and stakeholder engagement to ensure long-term sustainability and global recognition." },
        "Pillar: Sustainability": { milestones: ["M22","M23","M24","M35","M44"], description: "<strong>KPI:</strong> By 2029, embed sustainability principles across ONJCRIâ€™s research and operations by reducing carbon emissions, increasing biobank diversity, and achieving full participation in equity initiatives." },
        "Pillar: Ethical and Regulatory Conduct": { milestones: ["M20","M21","M41"], description: "<strong>KPI:</strong> By 2029, uphold the highest standards of ethics, governance, and regulatory compliance through continuous monitoring of research protocols, data security, and risk management frameworks." }
      };
    }

    function getMilestoneEmail(milestone){
      const emails = {
        "M1":"onjcri_pulse_1987359246_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M2":"onjcri_pulse_1987359247_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M9":"onjcri_pulse_1987359248_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M10.1":"onjcri_pulse_1987359249_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M10.2":"onjcri_pulse_1987368440_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M7":"onjcri_pulse_1987359250_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M8":"onjcri_pulse_1987359251_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M3":"onjcri_pulse_1987359252_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M4":"onjcri_pulse_1987359253_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M5":"onjcri_pulse_1987359256_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M6":"onjcri_pulse_1987359257_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M11":"onjcri_pulse_1987359259_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M17":"onjcri_pulse_1987380037_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M18":"onjcri_pulse_1987380044_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M19":"onjcri_pulse_1987380051_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M14":"onjcri_pulse_1987380060_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M15":"onjcri_pulse_1987380065_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M16":"onjcri_pulse_1987380069_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M12":"onjcri_pulse_1987380073_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M13":"onjcri_pulse_1987380079_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M26":"onjcri_pulse_1987380673_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M36":"onjcri_pulse_1987380676_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M38":"onjcri_pulse_1987380678_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M39":"onjcri_pulse_1987380682_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M40":"onjcri_pulse_1987380684_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M42":"onjcri_pulse_1987380687_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M25":"onjcri_pulse_1987380689_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M27":"onjcri_pulse_1987380691_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M28":"onjcri_pulse_1987380694_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M30":"onjcri_pulse_1987380698_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M31":"onjcri_pulse_1987380701_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M32":"onjcri_pulse_1987380703_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M33":"onjcri_pulse_1987380705_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M29":"onjcri_pulse_1987380709_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M34":"onjcri_pulse_1987380710_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M43":"onjcri_pulse_1987380714_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M37":"onjcri_pulse_1987380719_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M44":"onjcri_pulse_1987381563_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M23":"onjcri_pulse_1987381569_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M35":"onjcri_pulse_1987381566_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M24":"onjcri_pulse_1987381579_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M22":"onjcri_pulse_1987381574_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M41":"onjcri_pulse_1987381253_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M20":"onjcri_pulse_1987381256_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com",
        "M21":"onjcri_pulse_1987381262_a8698a0e5aa9c7801929__63497188@apse2.mx.monday.com"
      };
      return emails[milestone] || "default@onjcri.org";
    }

    /*********************
     * Search helpers (data)
     *********************/
    function norm(s){return (s||"").toString().toLowerCase();}
    function highlight(text, q){
      if(!q || !text) return text || "";
      const esc = q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      return text.replace(new RegExp(esc, 'ig'), m => `<mark>${m}</mark>`);
    }

    function itemMatchesQuery(item, q){
      if(!q) return true;
      const n = norm(q);
      // milestone fields
      if(norm(item.name).includes(n)) return true;
      if(norm(item.description).includes(n)) return true;
      if(norm(item.portfolio).includes(n)) return true;
      if(norm(item.date).includes(n)) return true;
      // any subitem field
      return item.subitems.some(s =>
        norm(s.name).includes(n) ||
        norm(s.status).includes(n) ||
        norm(s.timeline).includes(n) ||
        norm(s.sponsor).includes(n) ||
        norm(s.lead).includes(n)
      );
    }

    function subitemMatchesQuery(sub, q){
      if(!q) return true;
      const n = norm(q);
      return (
        norm(sub.name).includes(n) ||
        norm(sub.status).includes(n) ||
        norm(sub.timeline).includes(n) ||
        norm(sub.sponsor).includes(n) ||
        norm(sub.lead).includes(n)
      );
    }

    function filteredDataByQuery(data, q){
      if(!q) return JSON.parse(JSON.stringify(data));
      const out = { success: data.success, items: [] };
      data.items.forEach(item => {
        if(itemMatchesQuery(item, q)){
          const cloned = JSON.parse(JSON.stringify(item));
          // If milestone itself doesn't match but subitems do,
          // keep only matching subitems.
          if(!(norm(item.name).includes(norm(q)) || norm(item.description).includes(norm(q)))){
            cloned.subitems = cloned.subitems.filter(s => subitemMatchesQuery(s, q));
          }
          out.items.push(cloned);
        }
      });
      return out;
    }

    /*********************
     * Render
     *********************/
    function renderSections(dataToRender, q=""){
      const container = document.getElementById('milestoneSections');
      container.innerHTML = '';
      const sections = getSections();

      for(const [sectionTitle, { milestones, description }] of Object.entries(sections)){
        const itemsForSection = dataToRender.items.filter(i => milestones.includes(i.name));
        if(itemsForSection.length === 0) continue;

        const section = document.createElement('section');

        // Header (collapsible)
        const headerContainer = document.createElement('div');
        headerContainer.className = 'section-heading-container collapsed';
        const arrow = document.createElement('span');
        arrow.className = 'section-arrow';
        arrow.textContent = 'â–¼';
        const heading = document.createElement('h2');
        heading.className = 'section-heading';
        heading.innerHTML = highlight(sectionTitle, q);
        headerContainer.appendChild(arrow);
        headerContainer.appendChild(heading);
        section.appendChild(headerContainer);

        // KPI description
        const desc = document.createElement('p');
        desc.className = 'section-description';
        desc.innerHTML = description; // KPI copy, not highlighted to keep it tidy
        section.appendChild(desc);

        // Progress bar from subitems in this section
        const allSubs = itemsForSection.flatMap(i => i.subitems);
        const counts = {done:0,working:0,stuck:0,pending:0};
        allSubs.forEach(sub=>{
          const s = (sub.status||'').toLowerCase();
          if(s==='done') counts.done++;
          else if(s==='working on it') counts.working++;
          else if(s==='stuck') counts.stuck++;
          else counts.pending++;
        });
        const total = allSubs.length || 1;
        const progress = document.createElement('div');
        progress.className = 'kpi-progress-container';
        progress.innerHTML = `
          <div class="progress-bar">
            <div class="bar-segment bar-done" style="width:${(counts.done/total)*100}%" data-status="Done: ${counts.done} Activities"></div>
            <div class="bar-segment bar-working" style="width:${(counts.working/total)*100}%" data-status="Working on It: ${counts.working} Activities"></div>
            <div class="bar-segment bar-stuck" style="width:${(counts.stuck/total)*100}%" data-status="Stuck: ${counts.stuck} Activities"></div>
            <div class="bar-segment bar-pending" style="width:${(counts.pending/total)*100}%" data-status="Pending: ${counts.pending} Activities"></div>
          </div>`;
        section.appendChild(progress);

        // Milestones
        const listWrapper = document.createElement('div');
        listWrapper.classList.add('hidden');
        const list = document.createElement('ul');
        list.style.listStyle = 'none';
        list.style.paddingLeft = '0';

        itemsForSection.forEach((item, index)=>{
          const li = document.createElement('li');
          li.className = 'milestone-container';
          li.id = item.name;

          const allDone = milestoneAllActivitiesDone(item.name);
          const badgeClass = allDone ? 'milestone-badge done' : 'milestone-badge';
          const sublistId = `${sectionTitle.replace(/\s+/g,'-')}-sublist-${index}`;
          const toggleId  = `${sectionTitle.replace(/\s+/g,'-')}-toggle-${index}`;
          const completionTargetOverdue = item.date && isOverdue(item.date);

          const email = getMilestoneEmail(item.name);
          const emailBody = encodeURIComponent(`Dear ${item.name} Taskforce,\n\nI am writing regarding the progress of a strategic Milestone to which you have been assigned: ${item.description || "No description provided"}\n\n[Please add your specific question here].\n\nThank you,`);
          const mailtoLink = `mailto:${email}?subject=${encodeURIComponent("Enquiry regarding " + item.name)}&body=${emailBody}`;

          const subitemsHtml = item.subitems.map(sub=>{
            const s = (sub.status||'').toLowerCase();
            let statusClass='status-default', statusText='Unknown';
            if(s==='done'){statusClass='status-done';statusText='Done'}
            else if(s==='working on it'){statusClass='status-working';statusText='Working on It'}
            else if(s==='pending'){statusClass='status-pending';statusText='Pending'}
            else if(s==='stuck'){statusClass='status-stuck';statusText='Stuck'}
            const missingSponsor = !sub.sponsor;
            const missingLead = !sub.lead;
            const missingTimeline = !sub.timeline;
            const overdueClass = sub.timeline && isOverdue(sub.timeline.split('â€“').pop().trim()) && s!=='done' ? 'overdue' : (missingTimeline ? 'missing-data' : '');

            return `<li class="subitem">
                      <div class="status-indicator ${statusClass}" data-status="${statusText}"></div>
                      <div class="subitem-content">
                        <span class="pill"><strong>Activity:</strong> ${highlight(sub.name,q)}</span><br/>
                        <span class="pill"><strong>Executive Sponsor(s):</strong> <span class="${missingSponsor?'missing-data':''}">${highlight(sub.sponsor||'Not Assigned',q)}</span></span>
                        <span class="pill"><strong>Operational Lead(s):</strong> <span class="${missingLead?'missing-data':''}">${highlight(sub.lead||'Not Assigned',q)}</span></span>
                        <span class="pill"><strong>Timeline:</strong> <span class="${overdueClass}">${highlight(sub.timeline||'Missing',q)}</span></span>
                      </div>
                    </li>`;
          }).join('');

          li.innerHTML = `
            <div class="${badgeClass}">${item.name}</div>
            <div class="milestone-content">
              <div class="milestone-header">
                <span class="description">${highlight(item.description||'No description provided.', q)}</span>
                <button class="email-taskforce-btn" onclick="window.location.href='${mailtoLink}'" data-status="Email Taskforce for ${item.name}">Email Taskforce</button>
              </div>
              ${(item.portfolio||item.date)?`
              <div class="metadata-line">
                ${item.portfolio?`<span><strong>Executive Portfolio(s):</strong> ${highlight(item.portfolio,q)}</span>`:''}
                ${item.date?`<span><strong>Completion Target:</strong> <span class="${completionTargetOverdue?'overdue':''}">${highlight(item.date,q)}</span></span>`:''}
              </div>`:''}
              <div class="activity-summary">
                <div class="activity-toggle" id="${toggleId}">
                  <span class="arrow">â–¼</span>${item.subitems.length} Activities
                </div>
                <div class="status-circles">
                  ${item.subitems.map(sub=>{
                    const s = (sub.status||'').toLowerCase();
                    let cls='pending', label='Pending';
                    if(s==='done'){cls='done';label='Done'}
                    else if(s==='working on it'){cls='working';label='Working on It'}
                    else if(s==='stuck'){cls='stuck';label='Stuck'}
                    return `<div class="circle ${cls}" data-status="${label}"></div>`;
                  }).join('')}
                </div>
              </div>
              <ul id="${sublistId}" class="hidden sublist">${subitemsHtml}</ul>
            </div>`;

          list.appendChild(li);
          li.querySelector('.activity-toggle').onclick = () => toggleSublist(sublistId, toggleId);
        });

        listWrapper.appendChild(list);
        section.appendChild(listWrapper);

        headerContainer.onclick = () => {
          const isHidden = listWrapper.classList.toggle('hidden');
          headerContainer.classList.toggle('collapsed', isHidden);
        };

        container.appendChild(section);
      }

      // Tooltips
      document.querySelectorAll('.status-indicator,.status-circles .circle,.bar-segment,.email-taskforce-btn').forEach(el=>{
        el.addEventListener('mousemove', e => showTooltip(el.dataset.status||'', e.clientX, e.clientY));
        el.addEventListener('mouseleave', hideTooltip);
      });
    }

    function toggleSublist(sublistId, toggleId){
      const sublist = document.getElementById(sublistId);
      const toggle  = document.getElementById(toggleId);
      if(!sublist || !toggle) return;
      const isHidden = sublist.classList.toggle('hidden');
      toggle.classList.toggle('collapsed', isHidden);
    }

    /*********************
     * Strategy PDF search
     *********************/
    async function ensurePdfIndexed(){
      if(pdfIndexed || !ENABLE_STRATEGY_PDF_SEARCH) return;
      try{
        if(!pdfDocPromise){
          pdfDocPromise = pdfjsLib.getDocument(STRATEGY_PDF_URL).promise;
        }
        const pdf = await pdfDocPromise;
        const total = pdf.numPages;
        pdfPageText = [];
        // Load sequentially to be gentle
        for(let p=1;p<=total;p++){
          const page = await pdf.getPage(p);
          const content = await page.getTextContent();
          const text = content.items.map(i => i.str).join(' ');
          pdfPageText.push({page:p, text});
        }
        pdfIndexed = true;
      }catch(e){
        console.warn("PDF indexing failed (will silently disable PDF search):", e);
        pdfIndexed = false;
      }
    }

    function searchPdfForTerm(term){
      if(!pdfIndexed || !term) return [];
      const q = term.trim();
      if(!q) return [];
      const rx = new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'), 'i');
      const hits = [];
      for(const {page,text} of pdfPageText){
        const m = text.match(rx);
        if(m){
          const i = m.index;
          const SNIP = 90;
          const start = Math.max(0, i - SNIP);
          const end   = Math.min(text.length, i + q.length + SNIP);
          const raw = text.slice(start, end).replace(/\s+/g,' ').trim();
          const snippet = highlight(raw, q);
          hits.push({page, snippet});
          if(hits.length >= 20) break; // cap
        }
      }
      return hits;
    }

    function renderStrategyHits(term){
      const box  = document.getElementById('strategyBox');
      const list = document.getElementById('strategyHits');
      if(!ENABLE_STRATEGY_PDF_SEARCH || !term){
        box.style.display = 'none';
        list.innerHTML = '';
        return;
      }
      if(!pdfIndexed){
        box.style.display = 'block';
        list.innerHTML = `<div class="strategy-hit"><small>Searching strategyâ€¦</small></div>`;
        return;
      }
      const hits = searchPdfForTerm(term);
      if(hits.length === 0){
        box.style.display = 'none';
        list.innerHTML = '';
        return;
      }
      box.style.display = 'block';
      list.innerHTML = hits.map(h => `
        <div class="strategy-hit">
          <div class="hit-snippet">${h.snippet}</div>
          <small>
            Page ${h.page} &nbsp;â€¢&nbsp;
            <a href="${STRATEGY_PDF_URL}#page=${h.page}" target="_blank" rel="noopener">Open on page ${h.page}</a>
          </small>
        </div>
      `).join('');
    }

    /*********************
     * Wire up search UI
     *********************/
    async function runSearch(){
      const q = document.getElementById('searchInput').value.trim();
      currentQuery = q;
      const data = filteredDataByQuery(originalData, q);
      renderSections(data, q);

      if(ENABLE_STRATEGY_PDF_SEARCH){
        if(!pdfIndexed){
          // kick off indexing once, then render hits
          await ensurePdfIndexed();
        }
        renderStrategyHits(q);
      }
      expandAll(); // show results expanded when searching
    }

    function clearSearch(){
      const inp = document.getElementById('searchInput');
      inp.value = '';
      currentQuery = '';
      renderSections(originalData, '');
      document.getElementById('strategyBox').style.display = 'none';
      document.getElementById('strategyHits').innerHTML = '';
      collapseAll();
    }

    document.getElementById('btnSearch').addEventListener('click', runSearch);
    document.getElementById('btnClear').addEventListener('click', clearSearch);
    document.getElementById('searchInput').addEventListener('keydown', (e)=>{
      if(e.key === 'Enter') runSearch();
    });

    // Kick things off
    loadData();
    // Preload PDF index in the background (optional; harmless if disabled)
    if(ENABLE_STRATEGY_PDF_SEARCH){
      // Donâ€™t block render; start quietly
      ensurePdfIndexed();
    }
  </script>

  <!-- PDF.js (for Strategy PDF searching) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    // Point the worker to the same CDN version
    if(window['pdfjsLib']){
      pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
    }
  </script>
</body>
</html>
